<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Packliste verwalten</title>
  <style>
    /* Dark UI (angelehnt an dein Beispiel) */
    :root {
      --bg0: #05080f;
      --bg1: #070c16;
      --panel: rgba(17, 24, 39, 0.72);
      --panel2: rgba(20, 28, 46, 0.78);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --accent: #3ee38c;
      --accent2: #2fce7a;
      --danger: #ff4d6d;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);
      --radius: 18px;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 700px at 10% 10%, rgba(62,227,140,0.06), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(62,227,140,0.04), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 14px;
    }

    .app {
      width: min(1120px, 100%);
      display: grid;
      gap: 18px;
    }

    .topbar {
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(62,227,140,0.08);
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input[type="text"], input[type="number"] {
      background: rgba(0,0,0,0.28);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }

    button {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.26);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      font-weight: 600;
    }
    button:hover {
      background: rgba(0,0,0,0.35);
      border-color: rgba(255,255,255,0.18);
    }
    button:active { transform: scale(0.98); }
    .btn-accent {
      background: linear-gradient(180deg, rgba(62,227,140,0.20), rgba(62,227,140,0.12));
      border-color: rgba(62,227,140,0.35);
    }
    .btn-danger {
      background: rgba(255,77,109,0.10);
      border-color: rgba(255,77,109,0.35);
    }

    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 18px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow: hidden;
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 15px;
      font-weight: 800;
      color: rgba(255,255,255,0.86);
      letter-spacing: 0.2px;
    }
    .muted { color: var(--muted); }

    .list {
      display: grid;
      gap: 10px;
    }

    .list-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(0,0,0,0.22);
    }
    .list-row:hover {
      border-color: rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.27);
    }

    .list-title {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .list-title span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }

    .badge {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.76);
    }

    .row-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .items {
      display: grid;
      gap: 10px;
    }

    .item {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(0,0,0,0.22);
      padding: 10px;
      display: grid;
      gap: 8px;
      position: relative;
    }

    .item-top {
      display: grid;
      grid-template-columns: 30px 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .check {
      width: 20px;
      height: 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
    }
    .check.checked {
      background: rgba(62,227,140,0.18);
      border-color: rgba(62,227,140,0.40);
    }

    .item-name {
      font-weight: 750;
      color: rgba(255,255,255,0.88);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .qty {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .slider {
      width: min(360px, 100%);
    }

    .progress {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      min-width: 66px;
      text-align: center;
    }

    .mini {
      font-size: 12px;
      color: rgba(255,255,255,0.62);
    }

    .item-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .hidden { display: none !important; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }
    .modal.active { display: flex; }

    .modal-box {
      width: min(560px, 100%);
      background: rgba(15, 20, 33, 0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
      padding: 16px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .modal-title {
      font-weight: 900;
      margin: 0 0 8px 0;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .modal-actions button { min-width: 92px; }

    /* Bulkbar */
    .bulkbar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      width: min(980px, calc(100% - 28px));
      background: rgba(15, 20, 33, 0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
      padding: 10px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 998;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .bulkbar.active { display: flex; }

    .bulk-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      padding: 6px 10px;
      font-size: 13px;
      color: rgba(255,255,255,0.84);
    }

    .handle {
      cursor: grab;
      user-select: none;
      font-size: 16px;
      opacity: 0.8;
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
    }

    .dragging {
      opacity: 0.5;
    }

    /* Confirm/Prompt Input */
    .prompt-input {
      width: 100%;
      box-sizing: border-box;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>Packlisten</div>
        <span class="badge">Cloud</span>
      </div>

      <div class="controls">
        <select id="user-select"></select>
        <button id="user-manage" class="btn-accent">Benutzer</button>

        <button id="logout" class="btn-danger">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LINKS: Listen -->
      <div class="card">
        <h2>Listen</h2>
        <div class="muted mini" id="lists-hint">Wähle einen Benutzer aus, um Listen zu sehen.</div>

        <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
          <button id="add-list-btn" class="btn-accent">+ Neue Liste</button>
          <button id="lists-edit-btn">Bearbeiten</button>
        </div>

        <div class="list" id="lists-container" style="margin-top:12px;"></div>
      </div>

      <!-- RECHTS: Liste bearbeiten -->
      <div class="card">
        <div id="list-edit-section" class="hidden">
          <h2 id="list-edit-title">Liste</h2>
          <div class="muted mini" id="list-edit-sub">Items hinzufügen & abhaken.</div>

          <div style="display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;">
            <input id="new-item-name" type="text" placeholder="Neues Item..." />
            <input id="new-item-qty" type="number" min="1" value="1" style="width:90px;" />
            <button id="add-item-btn" class="btn-accent">Hinzufügen</button>

            <button id="back-to-lists-btn">Zurück</button>
          </div>

          <div class="items" id="items-container" style="margin-top:12px;"></div>
        </div>

        <div id="lists-section">
          <h2>Übersicht</h2>
          <div class="muted">Wähle links eine Liste aus oder erstelle eine neue.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Benutzer-Modal -->
  <div class="modal" id="user-modal">
    <div class="modal-box">
      <h3 class="modal-title">Benutzer verwalten</h3>
      <div class="muted">Benutzer/Profile gehören zu deinem Admin-Login und werden getrennt gespeichert.</div>
      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button id="user-add" class="btn-accent">+ Benutzer</button>
        <button id="user-delete" class="btn-danger">Benutzer löschen</button>
        <button id="user-close">Schließen</button>
      </div>
    </div>
  </div>

  <!-- Confirm/Prompt Modal -->
  <div class="modal" id="confirm-modal">
    <div class="modal-box">
      <h3 class="modal-title" id="confirm-title">Bestätigen</h3>
      <div class="muted" id="confirm-text">Text</div>

      <input id="prompt-input" class="prompt-input hidden" type="text" />

      <div class="modal-actions">
        <button id="confirm-cancel">Abbrechen</button>
        <button id="confirm-ok" class="btn-accent">OK</button>
      </div>
    </div>
  </div>

  <!-- Bulkbar -->
  <div class="bulkbar" id="bulkbar">
    <div class="bulk-left">
      <div class="pill" id="bulk-count">0 ausgewählt</div>
      <button id="bulk-move" class="btn-accent">Verschieben</button>
      <button id="bulk-copy">Kopieren</button>
      <button id="bulk-delete" class="btn-danger">Löschen</button>
      <button id="bulk-cancel">Abbrechen</button>
    </div>
    <div class="muted mini">Zum Verschieben nur am Griff ⠿ ziehen.</div>
  </div>

  <script>
  (function() {
    // =========================
    // Datenmodell (Client)
    // =========================
    let data = { users: [] }; // users == Profile
    let currentUserId = null;
    let currentListId = null;

    // Listen UI Zustand
    let listsEditMode = false;

    // Multi-Select Zustand
    const selectedItemIds = new Set();

    // DOM
    const userSelect = document.getElementById('user-select');
    const userManageBtn = document.getElementById('user-manage');
    const logoutBtn = document.getElementById('logout');

    const listsContainer = document.getElementById('lists-container');
    const listsHint = document.getElementById('lists-hint');
    const addListBtn = document.getElementById('add-list-btn');
    const listsEditBtn = document.getElementById('lists-edit-btn');

    const listEditSection = document.getElementById('list-edit-section');
    const listsSection = document.getElementById('lists-section');
    const listEditTitle = document.getElementById('list-edit-title');

    const itemsContainer = document.getElementById('items-container');
    const newItemName = document.getElementById('new-item-name');
    const newItemQty = document.getElementById('new-item-qty');
    const addItemBtn = document.getElementById('add-item-btn');
    const backToListsBtn = document.getElementById('back-to-lists-btn');

    // User Modal
    const userModal = document.getElementById('user-modal');
    const userAddBtn = document.getElementById('user-add');
    const userDeleteBtn = document.getElementById('user-delete');
    const userCloseBtn = document.getElementById('user-close');

    // Confirm/Prompt Modal
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmText = document.getElementById('confirm-text');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');
    const promptInput = document.getElementById('prompt-input');

    // Bulkbar
    const bulkbar = document.getElementById('bulkbar');
    const bulkCount = document.getElementById('bulk-count');
    const bulkMove = document.getElementById('bulk-move');
    const bulkCopy = document.getElementById('bulk-copy');
    const bulkDelete = document.getElementById('bulk-delete');
    const bulkCancel = document.getElementById('bulk-cancel');

    // ---- Routing: /packliste/<profilId>/<listId> (client-side) ----
    function getRouteParts() {
      const parts = location.pathname.split("/").filter(Boolean);
      if (parts[0] !== "packliste") return { userId: null, listId: null };
      return {
        userId: parts[1] ? decodeURIComponent(parts[1]) : null,
        listId: parts[2] ? decodeURIComponent(parts[2]) : null
      };
    }

    function setRoute(userId, listId, replace = false) {
      const base = "/packliste";
      const u = userId ? "/" + encodeURIComponent(userId) : "";
      const l = (userId && listId) ? "/" + encodeURIComponent(listId) : "";
      const url = base + u + l;
      if (replace) history.replaceState({}, "", url);
      else history.pushState({}, "", url);
    }

    function applyRouteToState() {
      const r = getRouteParts();

      // user
      if (r.userId && data?.users?.some(u => u.id === r.userId)) {
        currentUserId = r.userId;
      } else if (!currentUserId && data?.users?.length) {
        currentUserId = data.users[0].id;
        setRoute(currentUserId, null, true);
      }

      // list
      currentListId = null;
      if (currentUserId && r.listId) {
        const user = data.users.find(u => u.id === currentUserId);
        const exists = user?.lists?.some(l => l.id === r.listId);
        if (exists) currentListId = r.listId;
      }
    }

    window.addEventListener("popstate", () => {
      applyRouteToState();
      loadUsers(); // rendert passend zur URL
    });
    // --------------------------------------------------------------

    // =========================
    // Storage helpers
    // =========================
    function loadData() {
      try {
        const raw = localStorage.getItem('packlisteData');
        if (!raw) return { users: [] };
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.users)) return { users: [] };
        return obj;
      } catch(e) {
        return { users: [] };
      }
    }

    function saveData(extraProfilesToSave) {
      // Lokal (optional)
      try { localStorage.setItem('packlisteData', JSON.stringify(data)); } catch (_) {}

      // Cloud: NUR das aktuelle Profil speichern (Felix überschreibt Günther nicht)
      const u = data?.users?.find(x => x.id === currentUserId);
      if (u) {
        apiSaveProfile(u.id, u).catch(() => {});
      }

      // Optional: weitere Profile speichern (z.B. Teilen/Kopieren)
      if (Array.isArray(extraProfilesToSave)) {
        extraProfilesToSave.forEach(p => {
          if (p?.id) apiSaveProfile(p.id, p).catch(() => {});
        });
      }
    }

    // =========================
    // API (Profile getrennt)
    // =========================
    async function apiListProfiles() {
      const r = await fetch("/api/profiles", { credentials: "include" });
      if (r.status === 401) return { unauth: true, profiles: [] };
      if (!r.ok) throw new Error("apiListProfiles failed: " + r.status);
      const j = await r.json().catch(() => null);
      return { unauth: false, profiles: Array.isArray(j?.profiles) ? j.profiles : [] };
    }

    async function apiCreateProfile(name) {
      const r = await fetch("/api/profiles", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      if (r.status === 401) return { unauth: true, id: null };
      if (!r.ok) throw new Error("apiCreateProfile failed: " + r.status);
      const j = await r.json().catch(() => null);
      return { unauth: false, id: j?.id || null };
    }

    async function apiGetProfile(profileId) {
      const r = await fetch("/api/profiles/" + encodeURIComponent(profileId), { credentials: "include" });
      if (r.status === 401) return { unauth: true, data: null };
      if (!r.ok) throw new Error("apiGetProfile failed: " + r.status);
      const j = await r.json().catch(() => null);
      return { unauth: false, data: (j && ("data" in j) ? j.data : null) };
    }

    async function apiSaveProfile(profileId, profileData) {
      const r = await fetch("/api/profiles/" + encodeURIComponent(profileId), {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(profileData)
      });
      if (!r.ok) throw new Error("apiSaveProfile failed: " + r.status);
    }

    async function apiDeleteProfile(profileId) {
      const r = await fetch("/api/profiles/" + encodeURIComponent(profileId), {
        method: "DELETE",
        credentials: "include"
      });
      if (!r.ok) throw new Error("apiDeleteProfile failed: " + r.status);
    }

    // =========================
    // UI: Helpers
    // =========================
    function getCurrentUser() {
      return data.users.find(u => u.id === currentUserId) || null;
    }
    function getCurrentList() {
      const user = getCurrentUser();
      if (!user) return null;
      return user.lists.find(l => l.id === currentListId) || null;
    }

    function showListsSection() {
      listEditSection.classList.add('hidden');
      listsSection.classList.remove('hidden');
      selectedItemIds.clear();
      updateBulkbar();
    }
    function showListEditSection() {
      listEditSection.classList.remove('hidden');
      listsSection.classList.add('hidden');
      selectedItemIds.clear();
      updateBulkbar();
      renderItems();
    }

    // =========================
    // Confirm/Prompt
    // =========================
    let confirmCb = null;

    function showConfirm(text, onOk) {
      confirmCb = onOk || null;
      confirmTitle.textContent = "Bestätigen";
      confirmText.textContent = text;
      promptInput.classList.add('hidden');
      confirmModal.classList.add('active');
    }

    function showPrompt(text, defaultValue, onOk) {
      confirmCb = onOk || null;
      confirmTitle.textContent = "Eingabe";
      confirmText.textContent = text;
      promptInput.value = defaultValue || "";
      promptInput.classList.remove('hidden');
      confirmModal.classList.add('active');
      setTimeout(() => promptInput.focus(), 50);
    }

    confirmCancel.addEventListener('click', () => {
      confirmModal.classList.remove('active');
      confirmCb = null;
    });
    confirmOk.addEventListener('click', () => {
      const cb = confirmCb;
      confirmModal.classList.remove('active');
      confirmCb = null;
      if (promptInput.classList.contains('hidden')) {
        cb && cb();
      } else {
        cb && cb(promptInput.value);
      }
    });

    // =========================
    // Bulkbar
    // =========================
    function updateBulkbar() {
      const n = selectedItemIds.size;
      bulkCount.textContent = `${n} ausgewählt`;
      if (n > 0 && currentListId) bulkbar.classList.add('active');
      else bulkbar.classList.remove('active');
    }

    // =========================
    // Render: Benutzer + Listen
    // =========================
    function loadUsers() {
      userSelect.innerHTML = "";

      if (!data.users.length) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "Keine Benutzer";
        userSelect.appendChild(opt);
        userSelect.disabled = true;
        listsHint.textContent = "Erstelle zuerst einen Benutzer.";
        listsContainer.innerHTML = "";
        showListsSection();
        return;
      }

      userSelect.disabled = false;

      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.name;
        userSelect.appendChild(opt);
      });

      // Route anwenden (evtl. wurde direkt /packliste/<id>/<list> geöffnet)
      applyRouteToState();

      userSelect.value = currentUserId || data.users[0].id;
      currentUserId = userSelect.value;

      listsHint.textContent = `Benutzer: ${getCurrentUser()?.name || ""}`;
      loadLists();

      // Wenn URL auch eine Liste enthält → direkt öffnen
      if (currentListId) {
        showListEditSection();
      } else {
        showListsSection();
      }
    }

    function loadLists() {
      const user = getCurrentUser();
      listsContainer.innerHTML = "";
      if (!user) return;

      const lists = Array.isArray(user.lists) ? user.lists : [];
      if (!lists.length) {
        const div = document.createElement('div');
        div.className = "muted";
        div.textContent = "Noch keine Listen. Erstelle eine neue.";
        listsContainer.appendChild(div);
        showListsSection();
        return;
      }

      lists.forEach(list => {
        const row = document.createElement('div');
        row.className = 'list-row';

        const left = document.createElement('div');
        left.className = 'list-title';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = list.name || "Unbenannt";

        nameSpan.addEventListener('click', function() {
          currentListId = list.id;
          setRoute(currentUserId, currentListId);
          showListEditSection();
        });

        const badge = document.createElement('span');
        badge.className = 'badge';
        const total = Array.isArray(list.items) ? list.items.length : 0;
        const done = Array.isArray(list.items) ? list.items.filter(i => i.done).length : 0;
        badge.textContent = `${done}/${total}`;

        left.appendChild(nameSpan);
        left.appendChild(badge);

        const actions = document.createElement('div');
        actions.className = 'row-actions';

        if (listsEditMode) {
          const del = document.createElement('button');
          del.className = 'btn-danger';
          del.textContent = "Löschen";
          del.addEventListener('click', () => {
            showConfirm(`Liste "${list.name}" löschen?`, () => {
              user.lists = user.lists.filter(l => l.id !== list.id);
              if (currentListId === list.id) {
                currentListId = null;
                setRoute(currentUserId, null);
              }
              saveData();
              loadLists();
              showListsSection();
            });
          });
          actions.appendChild(del);
        } else {
          const open = document.createElement('button');
          open.textContent = "Öffnen";
          open.addEventListener('click', () => {
            currentListId = list.id;
            setRoute(currentUserId, currentListId);
            showListEditSection();
          });
          actions.appendChild(open);
        }

        row.appendChild(left);
        row.appendChild(actions);
        listsContainer.appendChild(row);
      });

      // Falls currentListId nicht mehr existiert:
      if (currentListId) {
        const exists = user.lists.some(l => l.id === currentListId);
        if (!exists) {
          currentListId = null;
          setRoute(currentUserId, null, true);
          showListsSection();
        }
      }
    }

    // =========================
    // Render: Items
    // =========================
    function renderItems() {
      const list = getCurrentList();
      itemsContainer.innerHTML = "";
      if (!list) return;

      listEditTitle.textContent = list.name || "Liste";

      if (!Array.isArray(list.items)) list.items = [];

      // Sort order
      list.items.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));

      list.items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.id = item.id;

        const top = document.createElement('div');
        top.className = 'item-top';

        const check = document.createElement('div');
        check.className = 'check' + (item.done ? ' checked' : '');
        check.textContent = item.done ? '✓' : '';
        check.addEventListener('click', () => {
          item.done = !item.done;
          saveData();
          renderItems();
          loadLists(); // badge aktualisieren
        });

        const name = document.createElement('div');
        name.className = 'item-name';
        name.textContent = item.name || "Item";

        const handle = document.createElement('div');
        handle.className = 'handle';
        handle.textContent = '⠿';
        handle.setAttribute('draggable', 'true');

        // Multi-select click on item (not handle)
        el.addEventListener('click', (e) => {
          if (e.target === handle) return;
          if (!listsEditMode && currentListId) {
            const id = item.id;
            if (selectedItemIds.has(id)) selectedItemIds.delete(id);
            else selectedItemIds.add(id);
            el.style.outline = selectedItemIds.has(id) ? "2px solid rgba(62,227,140,0.5)" : "none";
            updateBulkbar();
          }
        });

        top.appendChild(check);
        top.appendChild(name);
        top.appendChild(handle);

        const qtyWrap = document.createElement('div');
        qtyWrap.className = 'qty';

        const slider = document.createElement('input');
        slider.className = 'slider';
        slider.type = 'range';
        slider.min = 0;
        slider.max = item.qty || 1;
        slider.value = item.progress || 0;
        slider.addEventListener('input', () => {
          item.progress = Number(slider.value);
          progress.textContent = `${item.progress}/${item.qty}`;
          saveData();
          loadLists();
        });

        const progress = document.createElement('div');
        progress.className = 'progress';
        progress.textContent = `${item.progress || 0}/${item.qty || 1}`;

        qtyWrap.appendChild(slider);
        qtyWrap.appendChild(progress);

        el.appendChild(top);
        el.appendChild(qtyWrap);

        // Drag & Drop reorder (handle only)
        handle.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', item.id);
          el.classList.add('dragging');
        });
        handle.addEventListener('dragend', () => {
          el.classList.remove('dragging');
        });

        itemsContainer.appendChild(el);
      });

      // Drag over container
      itemsContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        const dragging = itemsContainer.querySelector('.dragging');
        if (!dragging) return;

        const after = getDragAfterElement(itemsContainer, e.clientY);
        if (after == null) itemsContainer.appendChild(dragging);
        else itemsContainer.insertBefore(dragging, after);
      });

      itemsContainer.addEventListener('drop', () => {
        const list = getCurrentList();
        if (!list) return;

        // Update order by current DOM
        const ids = [...itemsContainer.querySelectorAll('.item')].map(el => el.dataset.id);
        ids.forEach((id, idx) => {
          const it = list.items.find(i => i.id === id);
          if (it) it.order = idx;
        });

        saveData();
      });

      updateBulkbar();
    }

    function getDragAfterElement(container, y) {
      const els = [...container.querySelectorAll('.item:not(.dragging)')];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

      for (const child of els) {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: child };
        }
      }
      return closest.element;
    }

    // =========================
    // Bind UI
    // =========================
    function bindUI() {
      // Logout
      logoutBtn.addEventListener('click', async () => {
        await fetch("/api/logout", { method: "POST", credentials: "include" }).catch(()=>{});
        location.href = "/login?returnTo=" + encodeURIComponent("/packliste");
      });

      // User select
      document.getElementById('user-select').addEventListener('change', function() {
        currentUserId = this.value || null;
        currentListId = null;
        setRoute(currentUserId, null);
        loadLists();
      });

      // User modal
      userManageBtn.addEventListener('click', () => userModal.classList.add('active'));
      userCloseBtn.addEventListener('click', () => userModal.classList.remove('active'));

      document.getElementById('user-add').addEventListener('click', function() {
        showPrompt('Name des neuen Benutzers:', '', async function(name) {
          name = (name || '').trim();
          if (!name) return;

          try {
            const created = await apiCreateProfile(name);
            if (created.unauth || !created.id) { location.href = "/login"; return; }

            const id = created.id;
            const u = { id, name, lists: [] };

            data.users.push(u);
            currentUserId = id;
            currentListId = null;

            setRoute(currentUserId, null); // /packliste/<profilId>
            saveData(); // speichert aktuelles Profil

            loadUsers();
            userModal.classList.remove('active');
          } catch (e) {
            console.error(e);
            alert('Profil konnte nicht erstellt werden.');
          }
        });
      });

      document.getElementById('user-delete').addEventListener('click', function() {
        if (!currentUserId) return;
        const user = data.users.find(u => u.id === currentUserId);
        if (!user) return;

        showConfirm(`Benutzer "${user.name}" wirklich löschen?`, async function() {
          try {
            await apiDeleteProfile(currentUserId);
          } catch (e) {
            console.error(e);
            alert('Profil konnte nicht gelöscht werden.');
            return;
          }

          data.users = data.users.filter(u => u.id !== currentUserId);
          currentUserId = data.users[0]?.id || null;
          currentListId = null;
          listsEditMode = false;
          selectedItemIds.clear();

          setRoute(currentUserId, null, true);
          try { localStorage.setItem('packlisteData', JSON.stringify(data)); } catch (_) {}
          loadUsers();
          userModal.classList.remove('active');
        });
      });

      // Lists edit mode
      listsEditBtn.addEventListener('click', () => {
        listsEditMode = !listsEditMode;
        listsEditBtn.textContent = listsEditMode ? "Fertig" : "Bearbeiten";
        loadLists();
      });

      // Add list
      addListBtn.addEventListener('click', () => {
        if (!currentUserId) return;
        const user = getCurrentUser();
        if (!user) return;

        showPrompt("Name der neuen Liste:", "Neue Liste", (name) => {
          name = (name || "").trim();
          if (!name) return;

          const id = "l_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 7);
          user.lists.push({ id, name, items: [] });

          saveData();
          loadLists();
        });
      });

      // Back
      backToListsBtn.addEventListener('click', () => {
        currentListId = null;
        setRoute(currentUserId, null);
        showListsSection();
      });

      // Add item
      addItemBtn.addEventListener('click', () => {
        const list = getCurrentList();
        if (!list) return;

        const name = (newItemName.value || "").trim();
        const qty = Math.max(1, Number(newItemQty.value || 1));
        if (!name) return;

        const id = "i_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 7);
        list.items.push({
          id,
          name,
          qty,
          progress: 0,
          done: false,
          order: list.items.length
        });

        newItemName.value = "";
        newItemQty.value = 1;

        saveData();
        renderItems();
        loadLists();
      });

      // Bulkbar buttons (Platzhalter: nur Delete wirklich)
      bulkCancel.addEventListener('click', () => {
        selectedItemIds.clear();
        renderItems();
        updateBulkbar();
      });

      bulkDelete.addEventListener('click', () => {
        const list = getCurrentList();
        if (!list) return;

        showConfirm(`${selectedItemIds.size} Items löschen?`, () => {
          list.items = list.items.filter(i => !selectedItemIds.has(i.id));
          selectedItemIds.clear();
          saveData();
          renderItems();
          loadLists();
        });
      });

      bulkMove.addEventListener('click', () => {
        alert("Verschieben ist in deiner Version über Popups/Teilen umgesetzt – wenn du willst, baue ich es sauber fertig.");
      });

      bulkCopy.addEventListener('click', () => {
        alert("Kopieren ist in deiner Version über Popups/Teilen umgesetzt – wenn du willst, baue ich es sauber fertig.");
      });
    }

    // =========================
    // Initialisierung der Seite
    // =========================
    async function init() {
      // Helper: immer auf /login (mit returnTo) statt /home
      function goLogin() {
        const returnTo = location.pathname + location.search;
        location.href = "/login?returnTo=" + encodeURIComponent(returnTo);
      }

      // 1) Seite schützen: nur eingeloggt
      try {
        const meRes = await fetch("/api/me", { credentials: "include" });
        if (meRes.status === 401) { goLogin(); return; }
        const me = await meRes.json().catch(() => null);
        if (!me || !me.loggedIn) { goLogin(); return; }
      } catch (_) {
        goLogin();
        return;
      }

      // 2) Profile-Liste laden (pro Profil getrennt)
      let list = null;
      try {
        list = await apiListProfiles(); // { unauth, profiles }
      } catch (_) {
        list = null;
      }

      if (list && list.unauth) {
        goLogin();
        return;
      }

      data = { users: [] };

      if (list && Array.isArray(list.profiles) && list.profiles.length) {
        // jedes Profil einzeln laden
        for (const p of list.profiles) {
          try {
            const got = await apiGetProfile(p.id);
            if (got.unauth) { goLogin(); return; }

            let u = got.data;
            if (!u || typeof u !== "object") u = {};
            u.id = String(u.id || p.id);
            u.name = String(u.name || p.name || "Benutzer");
            if (!Array.isArray(u.lists)) u.lists = [];
            data.users.push(u);
          } catch (_) {
            data.users.push({ id: p.id, name: p.name || "Benutzer", lists: [] });
          }
        }
      } else {
        // keine Profile in Cloud → leer starten
        data = { users: [] };
      }

      // 3) Route anwenden (setzt currentUserId/currentListId aus URL)
      applyRouteToState();

      // 4) localStorage (optional)
      try { localStorage.setItem("packlisteData", JSON.stringify(data)); } catch (_) {}

      // 5) UI rendern
      bindUI();
      loadUsers();
    }

    // Kickstart
    document.addEventListener('DOMContentLoaded', init);
  })();

    // Wenn der Browser per "Zurück" eine gecachte Seite zeigt -> sofort Auth prüfen
    async function enforceAuth() {
      try {
        const r = await fetch("/api/me", { credentials: "include" });
        if (r.status === 401) location.href = "/login?returnTo=" + encodeURIComponent(location.pathname + location.search);
      } catch (_) {
        location.href = "/login?returnTo=" + encodeURIComponent(location.pathname + location.search);
      }
    }

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) enforceAuth(); // BFCache
    });

  </script>
</body>
</html>
