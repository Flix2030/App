<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Ordner</title>
  <style>
    :root{--bg0:#05080f;--bg1:#070c16;--panel:rgba(17,24,39,.72);--panel2:rgba(20,28,46,.78);--border:rgba(255,255,255,.10);--txt:rgba(255,255,255,.92);--mut:rgba(255,255,255,.62);--shadow:0 18px 60px rgba(0,0,0,.55);--r:18px}
    html,body{min-height:100vh;color-scheme:dark}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,.10), transparent 55%),radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,.08), transparent 55%),linear-gradient(180deg,var(--bg0),var(--bg1));color:var(--txt);display:flex;justify-content:center;align-items:flex-start;padding:22px 16px}
    .wrap{width:min(1100px,100%)}
    .bar{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px 16px;margin-bottom:14px}
    .barLeft{display:flex;align-items:center;gap:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:7px 10px;border-radius:999px;font-weight:800}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--txt);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:800}
    h2{margin:0 0 10px 2px;font-size:22px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;align-items:center;gap:14px;background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;user-select:none}
    .row:hover{filter:brightness(1.08)}
    .icon{width:44px;height:44px;border-radius:14px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.18);font-size:22px}
    .title{font-size:22px;font-weight:800}
    .mut{color:var(--mut);font-size:13px}

    .modalWrap{position:fixed;inset:0;display:none;background:rgba(0,0,0,.60);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:9999;padding:18px}
    .modal{max-width:560px;margin:12vh auto 0;background:rgba(22,24,30,.94);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .mHead{padding:14px;border-bottom:1px solid var(--border);font-weight:900;font-size:20px}
    .mBody{padding:14px}
    .mFoot{padding:14px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .fieldRow{display:flex;gap:10px;align-items:center}
    .field{flex:1;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--txt);padding:10px 12px;outline:none;font-size:15px}
    .err{color:rgba(255,77,109,.95);font-size:13px;min-height:18px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="barLeft">
        <div class="badge"><span>üìÅ</span><span id="folderName">Felix</span></div>
        <div id="lockBadge" class="badge">üîí gesperrt</div>
      </div>
      <button id="backBtn" class="btn">Zur√ºck</button>
    </div>

    <h2>Apps im Ordner:</h2>
    <div class="card">
      <ul id="items" class="list"></ul>
      <div id="empty" class="mut" style="display:none;padding:10px 2px;">Ordner ist leer.</div>
    </div>
  </div>

  <div id="pinModal" class="modalWrap">
    <div class="modal">
      <div class="mHead">Ordner entsperren</div>
      <div class="mBody">
        <div class="mut">Bitte Code eingeben.</div>
        <div style="height:10px"></div>
        <div class="fieldRow">
          <input id="pinInput" class="field" type="password" placeholder="PIN" autocomplete="current-password" />
          <button id="togglePin" class="btn" title="Anzeigen">üëÅÔ∏è</button>
        </div>
        <div class="err" id="pinErr"></div>
      </div>
      <div class="mFoot">
        <button id="pinCancel" class="btn">Abbrechen</button>
        <button id="pinOk" class="btn">Entsperren</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const APP_REGISTRY = {
    misterx:   { id:"misterx",   name:"MisterX", icon:"‚ùå", href:"/MisterX.html" },
    webcam:    { id:"webcam",    name:"Webcam",  icon:"üì∑", href:"/webcam-live" },
    // falls du spaeter mehr reinlegst:
    settings:  { id:"settings",  name:"Einstellungen", icon:"‚öôÔ∏è", href:"/settings.html" },
    vokabeln:  { id:"vokabeln",  name:"Vokabeln",      icon:"üóÇÔ∏è", href:"/vokabeln.html" },
    lernen:    { id:"lernen",    name:"Lernen",        icon:"üß†", href:"/lernen" },
    packliste: { id:"packliste", name:"Packliste",     icon:"üß≥", href:"/packliste.html" },
    einkauf:   { id:"einkauf",   name:"Einkaufsliste", icon:"üõí", href:"/einkaufsliste" },
    todo:      { id:"todo",      name:"ToDo",          icon:"‚úÖ", href:"/todo.html" }
  };

  const els = {
    name: document.getElementById('folderName'),
    lockBadge: document.getElementById('lockBadge'),
    backBtn: document.getElementById('backBtn'),
    items: document.getElementById('items'),
    empty: document.getElementById('empty'),
    modal: document.getElementById('pinModal'),
    pinInput: document.getElementById('pinInput'),
    pinErr: document.getElementById('pinErr'),
    pinOk: document.getElementById('pinOk'),
    pinCancel: document.getElementById('pinCancel'),
    togglePin: document.getElementById('togglePin')
  };

  const params = new URLSearchParams(location.search);
  const folderId = params.get('folderId') || '';

  function tokenKey(){ return 'home_unlock_token:' + folderId; }
  function unlockedKey(){ return 'folder_unlocked:' + folderId; }
  function returnKey(){ return 'return_to_folder_once'; }

  function normHref(href){
    href = String(href || '/');
    if (href.startsWith('http://') || href.startsWith('https://')) return href;
    if (href.startsWith('/')) return href;
    return '/' + href.replace(/^\.\//,'').replace(/^\/+/, '');
  }

  function showPinModal(){
    els.modal.style.display='block';
    els.pinErr.textContent='';
    els.pinInput.value='';
    els.pinInput.type='password';
    els.togglePin.textContent='üëÅÔ∏è';
    setTimeout(()=>els.pinInput.focus(), 30);
  }
  function hidePinModal(){ els.modal.style.display='none'; }

  async function apiLayout(){
    const r = await fetch('/api/home/layout', { credentials:'include' });
    const j = await r.json();
    if (!r.ok || !j?.ok) throw new Error(j?.error || 'layout_failed');
    return j;
  }

  async function apiUnlock(pin){
    const r = await fetch('/api/home/folder/unlock', {
      method:'POST',
      credentials:'include',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify({ folderId, pin })
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j?.ok) throw new Error(j?.error || ('unlock_http_' + r.status));
    return j.token;
  }

  async function apiFolderItems(token){
    const url = `/api/home/folder/items?folderId=${encodeURIComponent(folderId)}&token=${encodeURIComponent(token||'')}`;
    const r = await fetch(url, { credentials:'include' });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j?.ok) throw new Error(j?.error || ('items_http_' + r.status));
    return j.items || [];
  }

  function askPin(){
    return new Promise((resolve)=>{
      showPinModal();

      const onToggle = ()=>{
        const isPw = els.pinInput.type === 'password';
        els.pinInput.type = isPw ? 'text' : 'password';
        els.togglePin.textContent = isPw ? 'üôà' : 'üëÅÔ∏è';
        els.pinInput.focus();
      };

      const cleanup = ()=>{
        els.pinOk.removeEventListener('click', onOk);
        els.pinCancel.removeEventListener('click', onCancel);
        els.togglePin.removeEventListener('click', onToggle);
        els.pinInput.removeEventListener('keydown', onKey);
        els.modal.removeEventListener('click', onBg);
      };

      const onCancel = ()=>{
        hidePinModal(); cleanup();
        // Cancel soll sinnvoll sein: raus nach Home
        location.replace('/home');
      };

      const onBg = (e)=>{ if (e.target === els.modal) onCancel(); };

      const onKey = (e)=>{
        if (e.key === 'Enter') onOk();
        if (e.key === 'Escape') onCancel();
      };

      const onOk = async ()=>{
        const pin = String(els.pinInput.value||'').trim();
        if (!pin){ els.pinErr.textContent='PIN fehlt.'; return; }
        try{
          const token = await apiUnlock(pin);
          hidePinModal(); cleanup();
          resolve(token);
        }catch(err){
          const msg = String(err?.message || err || '');
          if (msg === 'too_many_attempts') els.pinErr.textContent='Zu viele Versuche. Warte kurz.';
          else els.pinErr.textContent='Falscher Code.';
        }
      };

      els.pinOk.addEventListener('click', onOk);
      els.pinCancel.addEventListener('click', onCancel);
      els.togglePin.addEventListener('click', onToggle);
      els.pinInput.addEventListener('keydown', onKey);
      els.modal.addEventListener('click', onBg);
    });
  }

  function renderItems(ids){
    els.items.innerHTML='';
    if (!ids.length){ els.empty.style.display='block'; return; }
    els.empty.style.display='none';
    for (const id of ids){
      const app = APP_REGISTRY[id] || { id, name:id, icon:'üß©', href:'/' };
      const li = document.createElement('li');
      li.className='row';
      li.innerHTML = `<div class="icon">${app.icon||'üß©'}</div><div class="title">${app.name||id}</div>`;
      li.addEventListener('click', ()=>{
        // merken: wenn Home gedrueckt wird, soll es wieder in den Ordner gehen (ohne neue PIN)
        sessionStorage.setItem(returnKey(), folderId);
        location.href = normHref(app.href);
      });
      els.items.appendChild(li);
    }
  }

  function setUnlockedUI(isUnlocked){
    els.lockBadge.textContent = isUnlocked ? '‚úÖ entsperrt' : 'üîí gesperrt';
  }

  async function loadAndShow(){
    if (!folderId){ location.replace('/home'); return; }

    // Name aus Layout ziehen
    try{
      const data = await apiLayout();
      const f = (data.layout?.folders || []).find(x => String(x.id) === String(folderId));
      els.name.textContent = f?.name || 'Felix';
    }catch{ els.name.textContent = 'Felix'; }

    // Back button: IMMER nach Home (nicht history.back)
    els.backBtn.addEventListener('click', ()=>{
      // Token absichtlich loeschen, damit naechster Einstieg wieder PIN verlangt
      sessionStorage.removeItem(tokenKey());
      sessionStorage.removeItem(unlockedKey());
      sessionStorage.removeItem(returnKey());
      location.href = '/home';
    });

    // Erst versuchen: Token aus sessionStorage
    let token = sessionStorage.getItem(tokenKey());

    if (token){
      try{
        const items = await apiFolderItems(token);
        setUnlockedUI(true);
        renderItems(items);
        return;
      }catch{
        // token ungueltig -> neu PIN
        token = null;
        sessionStorage.removeItem(tokenKey());
        sessionStorage.removeItem(unlockedKey());
      }
    }

    // Kein Token -> PIN fragen
    setUnlockedUI(false);
    const newToken = await askPin();
    if (!newToken) return;

    sessionStorage.setItem(tokenKey(), newToken);
    sessionStorage.setItem(unlockedKey(), String(Date.now()));

    const items = await apiFolderItems(newToken);
    setUnlockedUI(true);
    renderItems(items);
  }

  document.addEventListener('DOMContentLoaded', loadAndShow);
})();
</script>
</body>
</html>
