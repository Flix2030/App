<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ordner</title>
  <meta name="theme-color" content="#070c16">
  <style>
    :root{
      --bg:#070c16;
      --card: rgba(16,20,33,0.70);
      --card2: rgba(16,20,33,0.85);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 20%, rgba(46,120,255,0.20), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(255,92,180,0.14), transparent 55%),
        radial-gradient(900px 600px at 55% 85%, rgba(80,255,170,0.12), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
      padding:24px;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 18px;
      border-bottom:1px solid var(--border);
    }
    .title{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:900;
      font-size: 22px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
      font-size: 13px;
      font-weight: 800;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.92);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
    }
    .body{ padding: 18px; }
    .muted{ color: var(--muted); }
    .list{ list-style:none; padding:0; margin: 14px 0 0 0; display:flex; flex-direction:column; gap:12px; }
    .row{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(11,16,28,0.55);
    }
    .row.click{ cursor:pointer; }
    .row.click:hover{ border-color: rgba(255,255,255,0.18); background: rgba(11,16,28,0.65); }
    .icon{
      width: 46px;
      height: 46px;
      display:grid;
      place-items:center;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size: 22px;
    }
    .name{ font-size: 20px; font-weight: 900; }

    /* Modal */
    .modalWrap{
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0,0,0,0.60);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 18px;
      z-index: 9999;
    }
    .modalCard{
      max-width: 520px;
      margin: 12vh auto 0 auto;
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    .modalHead{ padding: 14px; border-bottom:1px solid var(--border); font-weight: 900; }
    .modalBody{ padding: 14px; }
    .modalFoot{ padding: 14px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; }
    .fieldRow{ display:flex; gap:10px; align-items:center; }
    .field{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      padding: 11px 12px;
      outline:none;
      font-size: 15px;
    }
    .eye{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      font-size: 18px;
    }
    .errText{ color: rgba(255,77,109,0.95); font-size: 13px; min-height: 18px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <span id="fIcon">üìÅ</span>
        <span id="fName">Ordner</span>
        <span id="fBadge" class="badge">üîí gesperrt</span>
      </div>
      <button class="btn" id="backBtn">Zur√ºck</button>
    </div>
    <div class="body">
      <div id="hint" class="muted">Laden‚Ä¶</div>
      <ul id="list" class="list"></ul>
    </div>
  </div>

  <div class="modalWrap" id="modal">
    <div class="modalCard">
      <div class="modalHead">Ordner entsperren</div>
      <div class="modalBody">
        <div class="muted" id="mInfo">Bitte PIN eingeben.</div>
        <div style="height:10px"></div>
        <div class="fieldRow">
          <input id="mPin" class="field" type="password" placeholder="PIN" autocomplete="current-password" />
          <button id="mEye" class="eye" title="PIN anzeigen">üëÅÔ∏è</button>
        </div>
        <div class="errText" id="mErr"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="mCancel">Abbrechen</button>
        <button class="btn" id="mOk">Entsperren</button>
      </div>
    </div>
  </div>

  <script>
    (async ()=>{
      const APP_REGISTRY = {
        settings:  { id:"settings",  name:"Einstellungen", icon:"‚öôÔ∏è", href:"/settings.html" },
        vokabeln:  { id:"vokabeln",  name:"Vokabeln",      icon:"üìö", href:"/vokabeln.html" },
        lernen:    { id:"lernen",    name:"Lernen",        icon:"üß†", href:"/lernen" },
        packliste: { id:"packliste", name:"Packliste",     icon:"üß≥", href:"/packliste.html" },
        einkauf:   { id:"einkauf",   name:"Einkaufsliste", icon:"üõí", href:"/einkaufsliste" },
        todo:      { id:"todo",      name:"ToDo",          icon:"‚úÖ", href:"/todo.html" },
        misterx:   { id:"misterx",   name:"MisterX",       icon:"‚ùå", href:"/MisterX.html" },
        webcam:    { id:"webcam",    name:"Webcam",        icon:"üì∑", href:"/webcam-live" }
      };

      const qs = new URLSearchParams(location.search);
      const folderId = String(qs.get("folderId") || "");

      const fIcon = document.getElementById("fIcon");
      const fName = document.getElementById("fName");
      const fBadge = document.getElementById("fBadge");
      const hint = document.getElementById("hint");
      const list = document.getElementById("list");
      const backBtn = document.getElementById("backBtn");

      const modal = document.getElementById("modal");
      const mInfo = document.getElementById("mInfo");
      const mPin = document.getElementById("mPin");
      const mEye = document.getElementById("mEye");
      const mErr = document.getElementById("mErr");
      const mCancel = document.getElementById("mCancel");
      const mOk = document.getElementById("mOk");

      function normHref(href){
        href = String(href || "/");
        if (href.startsWith("http://") || href.startsWith("https://")) return href;
        if (href.startsWith("/")) return href;
        return "/" + href.replace(/^\.\//, "").replace(/^\/+/, "");
      }

      backBtn.addEventListener("click", ()=>{
        if (history.length > 1) history.back();
        else location.href = "/home";
      });

      function takeHandoffToken(){
        try{
          const k = "home_unlock_token:" + folderId;
          const t = sessionStorage.getItem(k) || "";
          if (t) sessionStorage.removeItem(k); // one-time
          return String(t || "");
        }catch(_){ return ""; }
      }

      function appRow(appId){
        const app = APP_REGISTRY[appId];
        if (!app) return null;
        const li = document.createElement("li");
        li.className = "row click";
        li.addEventListener("click", ()=> location.href = normHref(app.href));
        const ic = document.createElement("div");
        ic.className = "icon";
        ic.textContent = app.icon || "üß©";
        const nm = document.createElement("div");
        nm.className = "name";
        nm.textContent = app.name || appId;
        li.appendChild(ic);
        li.appendChild(nm);
        return li;
      }

      function showModal(){ modal.style.display = "block"; setTimeout(()=>mPin.focus(), 30); }
      function hideModal(){ modal.style.display = "none"; mPin.value = ""; mErr.textContent = ""; }

      // Eye toggle
      let pinShown = false;
      mEye.addEventListener("click", (e)=>{
        e.preventDefault();
        pinShown = !pinShown;
        mPin.type = pinShown ? "text" : "password";
        mEye.textContent = pinShown ? "üôà" : "üëÅÔ∏è";
      });

      mCancel.addEventListener("click", ()=>{
        hideModal();
      });

      async function apiGetLayout(){
        const r = await fetch("/api/home/layout", { credentials:"include" });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j?.ok) throw new Error(j?.error || ("layout_http_"+r.status));
        return j;
      }

      async function apiUnlock(pin){
        const r = await fetch("/api/home/folder/unlock", {
          method:"POST",
          credentials:"include",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ folderId, pin })
        });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j?.ok) throw new Error(j?.error || ("unlock_http_"+r.status));
        return String(j.token || "");
      }

      async function apiGetItems(token){
        const u = new URL(location.origin + "/api/home/folder/items");
        u.searchParams.set("folderId", folderId);
        if (token) u.searchParams.set("token", token);
        const r = await fetch(u.toString(), { credentials:"include" });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j?.ok) throw new Error(j?.error || ("items_http_"+r.status));
        return Array.isArray(j.items) ? j.items : [];
      }

      async function unlockFlow(){
        return new Promise((resolve)=>{
          mInfo.textContent = "Bitte PIN eingeben.";
          mErr.textContent = "";
          mPin.value = "";
          pinShown = false; mPin.type = "password"; mEye.textContent = "üëÅÔ∏è";
          showModal();

          async function onOk(){
            mErr.textContent = "";
            const pin = String(mPin.value || "").trim();
            if (!pin){ mErr.textContent = "PIN fehlt."; return; }
            try{
              const token = await apiUnlock(pin);
              hideModal();
              cleanup();
              resolve(token);
            }catch(e){
              const msg = String(e?.message || e || "");
              if (msg.includes("too_many_attempts")) mErr.textContent = "Zu viele Versuche. Warte kurz.";
              else mErr.textContent = "Falscher Code.";
            }
          }

          function onKey(e){
            if (e.key === "Enter") onOk();
            if (e.key === "Escape"){ hideModal(); cleanup(); resolve(""); }
          }

          function onBg(e){
            if (e.target === modal){ hideModal(); cleanup(); resolve(""); }
          }

          function cleanup(){
            mOk.removeEventListener("click", onOk);
            mPin.removeEventListener("keydown", onKey);
            modal.removeEventListener("click", onBg);
          }

          mOk.addEventListener("click", onOk);
          mPin.addEventListener("keydown", onKey);
          modal.addEventListener("click", onBg);
        });
      }

      if (!folderId){
        hint.textContent = "Fehler: folderId fehlt.";
        fBadge.textContent = "‚ö†Ô∏è";
        return;
      }

      try{
        const data = await apiGetLayout();
        const layout = data.layout || {};
        const locks = data.locks || {};
        const folderItemsFallback = data.folderItems || {};

        const folderMeta = (Array.isArray(layout.folders) ? layout.folders : []).find(f=>String(f.id)===folderId);
        if (folderMeta){
          fIcon.textContent = folderMeta.icon || "üìÅ";
          fName.textContent = folderMeta.name || "Ordner";
        }

        const isLocked = !!locks[folderId];
        fBadge.textContent = isLocked ? "üîí gesperrt" : "‚úÖ entsperrt";

        // Show fallback items immediately
        const fallback = Array.isArray(folderItemsFallback[folderId]) ? folderItemsFallback[folderId] : [];
        if (fallback.length){
          hint.textContent = "Apps im Ordner:";
          list.innerHTML = "";
          for (const id of fallback){
            const el = appRow(id);
            if (el) list.appendChild(el);
          }
        } else {
          hint.textContent = "Keine Apps im Ordner.";
        }

        let token = "";
        if (isLocked){
          // If we came from Home, we should already have a one-time token.
          token = takeHandoffToken();
          if (!token){
            // fallback: ask PIN here
            token = await unlockFlow();
          }
          if (!token){
            hint.textContent = "Gesperrt.";
            list.innerHTML = "";
            return;
          }
          fBadge.textContent = "‚úÖ entsperrt";
        }

        // Load real items from API
        const items = await apiGetItems(token);
        if (!items.length){
          hint.textContent = "Keine Apps im Ordner.";
          list.innerHTML = "";
        } else {
          hint.textContent = "Apps im Ordner:";
          list.innerHTML = "";
          for (const id of items){
            const el = appRow(id);
            if (el) list.appendChild(el);
          }
        }
      }catch(e){
        hint.textContent = "Fehler beim Laden.";
        list.innerHTML = "";
      }
    })();
  </script>
</body>
</html>
