<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Home</title>
  <style>
    :root{--bg0:#05080f;--bg1:#070c16;--panel:rgba(17,24,39,.72);--panel2:rgba(20,28,46,.78);--border:rgba(255,255,255,.10);--txt:rgba(255,255,255,.92);--mut:rgba(255,255,255,.62);--shadow:0 18px 60px rgba(0,0,0,.55);--r:18px}
    html,body{min-height:100vh;color-scheme:dark}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,.10), transparent 55%),radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,.08), transparent 55%),linear-gradient(180deg,var(--bg0),var(--bg1));color:var(--txt);display:flex;justify-content:center;align-items:flex-start;padding:22px 16px}
    .wrap{width:min(1100px,100%)}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{margin:0;font-size:46px;font-weight:900;letter-spacing:.2px}
    h2{margin:18px 0 10px 0;font-size:34px}
    .status{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:10px 14px;border-radius:999px}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.45);box-shadow:0 0 12px rgba(255,255,255,.20)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;align-items:center;gap:14px;background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;user-select:none}
    .row:hover{filter:brightness(1.08)}
    .icon{width:44px;height:44px;border-radius:14px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.18);font-size:22px}
    .title{font-size:22px;font-weight:800}
    .mut{color:var(--mut);font-size:13px}

    .modalWrap{position:fixed;inset:0;display:none;background:rgba(0,0,0,.60);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:9999;padding:18px}
    .modal{max-width:560px;margin:12vh auto 0;background:rgba(22,24,30,.94);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .mHead{padding:14px;border-bottom:1px solid var(--border);font-weight:900;font-size:20px}
    .mBody{padding:14px}
    .mFoot{padding:14px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .fieldRow{display:flex;gap:10px;align-items:center}
    .field{flex:1;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--txt);padding:10px 12px;outline:none;font-size:15px}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--txt);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:800}
    .err{color:rgba(255,77,109,.95);font-size:13px;min-height:18px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Home</h1>
      <div class="status"><span id="dot" class="dot"></span><span id="statusText">Laden</span></div>
    </div>

    <h2>Apps</h2>
    <div class="card">
      <ul id="apps" class="list"></ul>
      <div id="appsEmpty" class="mut" style="display:none;padding:10px 2px;">Keine Apps.</div>
    </div>

    <h2 style="margin-top:22px;">Spiele</h2>
    <div class="card">
      <ul id="games" class="list"></ul>
      <div id="gamesEmpty" class="mut" style="display:none;padding:10px 2px;">Keine Spiele.</div>
    </div>

    <h2 style="margin-top:22px;">Ordner</h2>
    <div class="card">
      <ul id="folders" class="list"></ul>
      <div id="foldersEmpty" class="mut" style="display:none;padding:10px 2px;">Keine Ordner.</div>
    </div>
  </div>

  <div id="pinModal" class="modalWrap">
    <div class="modal">
      <div class="mHead">Ordner entsperren</div>
      <div class="mBody">
        <div class="mut">Bitte Code eingeben.</div>
        <div style="height:10px"></div>
        <div class="fieldRow">
          <input id="pinInput" class="field" type="password" placeholder="PIN" autocomplete="current-password" />
          <button id="togglePin" class="btn" title="Anzeigen">üëÅÔ∏è</button>
        </div>
        <div class="err" id="pinErr"></div>
      </div>
      <div class="mFoot">
        <button id="pinCancel" class="btn">Abbrechen</button>
        <button id="pinOk" class="btn">Entsperren</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const APP_REGISTRY = {
    settings:  { id:"settings",  name:"Einstellungen", icon:"‚öôÔ∏è", href:"/settings.html" },
    vokabeln:  { id:"vokabeln",  name:"Vokabeln",      icon:"üóÇÔ∏è", href:"/vokabeln.html" },
    lernen:    { id:"lernen",    name:"Lernen",        icon:"üß†", href:"/lernen" },
    packliste: { id:"packliste", name:"Packliste",     icon:"üß≥", href:"/packliste.html" },
    einkauf:   { id:"einkauf",   name:"Einkaufsliste", icon:"üõí", href:"/einkaufsliste" },
    todo:      { id:"todo",      name:"ToDo",          icon:"‚úÖ", href:"/todo.html" },
    luckycube:{ id:"luckycube", name:"Lucky Cube", icon:"üé≤", href:"/spiele/lucky-cube.html" },

  };

  const DEFAULT_UNASSIGNED = ["settings","vokabeln","lernen","packliste","einkauf","todo","misterx","webcam"];

  const els = {
    dot: document.getElementById('dot'),
    statusText: document.getElementById('statusText'),
    apps: document.getElementById('apps'),
    appsEmpty: document.getElementById('appsEmpty'),
    folders: document.getElementById('folders'),
    foldersEmpty: document.getElementById('foldersEmpty'),
    modal: document.getElementById('pinModal'),
    pinInput: document.getElementById('pinInput'),
    pinErr: document.getElementById('pinErr'),
    pinOk: document.getElementById('pinOk'),
    pinCancel: document.getElementById('pinCancel'),
    togglePin: document.getElementById('togglePin')
  };

  function setStatus(mode){
    if (mode === 'loading'){
      els.dot.style.background = 'rgba(255,255,255,.45)';
      els.dot.style.boxShadow = '0 0 12px rgba(255,255,255,.20)';
      els.statusText.textContent = 'Laden';
    } else if (mode === 'loaded'){
      els.dot.style.background = 'rgba(62,227,140,.95)';
      els.dot.style.boxShadow = '0 0 14px rgba(62,227,140,.55)';
      els.statusText.textContent = 'Geladen';
    } else {
      els.dot.style.background = 'rgba(255,77,109,.95)';
      els.dot.style.boxShadow = '0 0 14px rgba(255,77,109,.55)';
      els.statusText.textContent = 'Fehler';
    }
  }

  function normHref(href){
    href = String(href || '/');
    if (href.startsWith('http://') || href.startsWith('https://')) return href;
    if (href.startsWith('/')) return href;
    return '/' + href.replace(/^\.\//,'').replace(/^\/+/, '');
  }

  function appRow(appId){
    const app = APP_REGISTRY[appId];
    if (!app) return null;
    const li = document.createElement('li');
    li.className = 'row';
    li.innerHTML = `<div class="icon">${app.icon||'üß©'}</div><div class="title">${app.name||appId}</div>`;
    li.addEventListener('click', ()=> location.href = normHref(app.href));
    return li;
  }

  function folderRow(folder, locked){
    const li = document.createElement('li');
    li.className = 'row';
    const lockTxt = locked ? ' üîí' : '';
    li.innerHTML = `<div class="icon">üìÅ</div><div class="title">${folder.name || 'Felix'}${lockTxt}</div>`;
    li.addEventListener('click', ()=> openFolderFlow(folder));
    return li;
  }

  function showPinModal(){
    els.modal.style.display = 'block';
    els.pinErr.textContent = '';
    els.pinInput.value = '';
    els.pinInput.type = 'password';
    els.togglePin.textContent = 'üëÅÔ∏è';
    setTimeout(()=>els.pinInput.focus(), 30);
  }
  function hidePinModal(){
    els.modal.style.display = 'none';
  }

  function tokenKey(folderId){ return 'home_unlock_token:' + folderId; }
  function unlockedKey(folderId){ return 'folder_unlocked:' + folderId; }
  function returnKey(){ return 'return_to_folder_once'; }

  async function apiLayout(){
    const r = await fetch('/api/home/layout', { credentials:'include' });
    const j = await r.json();
    if (!r.ok || !j?.ok) throw new Error(j?.error || 'layout_failed');
    return j;
  }

  async function apiUnlock(folderId, pin){
    const r = await fetch('/api/home/folder/unlock', {
      method:'POST',
      credentials:'include',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify({ folderId, pin })
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j?.ok) throw new Error(j?.error || ('unlock_http_' + r.status));
    return j.token;
  }

  function askPin(folder){
    return new Promise((resolve)=>{
      showPinModal();

      const onToggle = ()=>{
        const isPw = els.pinInput.type === 'password';
        els.pinInput.type = isPw ? 'text' : 'password';
        els.togglePin.textContent = isPw ? 'üôà' : 'üëÅÔ∏è';
        els.pinInput.focus();
      };

      const cleanup = ()=>{
        els.pinOk.removeEventListener('click', onOk);
        els.pinCancel.removeEventListener('click', onCancel);
        els.togglePin.removeEventListener('click', onToggle);
        els.pinInput.removeEventListener('keydown', onKey);
        els.modal.removeEventListener('click', onBg);
      };

      const onCancel = ()=>{
        hidePinModal(); cleanup(); resolve(null);
      };

      const onBg = (e)=>{ if (e.target === els.modal) onCancel(); };

      const onKey = (e)=>{
        if (e.key === 'Enter') onOk();
        if (e.key === 'Escape') onCancel();
      };

      const onOk = async ()=>{
        const pin = String(els.pinInput.value||'').trim();
        if (!pin){ els.pinErr.textContent = 'PIN fehlt.'; return; }
        try{
          const token = await apiUnlock(folder.id, pin);
          hidePinModal(); cleanup();
          resolve(token);
        }catch(err){
          const msg = String(err?.message || err || '');
          if (msg === 'too_many_attempts') els.pinErr.textContent = 'Zu viele Versuche. Warte kurz.';
          else if (msg === 'not_locked') els.pinErr.textContent = 'Ordner ist nicht gesperrt.';
          else els.pinErr.textContent = 'Falscher Code.';
        }
      };

      els.pinOk.addEventListener('click', onOk);
      els.pinCancel.addEventListener('click', onCancel);
      els.togglePin.addEventListener('click', onToggle);
      els.pinInput.addEventListener('keydown', onKey);
      els.modal.addEventListener('click', onBg);
    });
  }

  async function openFolderFlow(folder){
    // Immer PIN beim Klick auf den Ordner von Home aus.
    const token = await askPin(folder);
    if (!token) return;

    sessionStorage.setItem(tokenKey(folder.id), token);
    sessionStorage.setItem(unlockedKey(folder.id), String(Date.now()));

    location.href = `/folder?folderId=${encodeURIComponent(folder.id)}`;
  }

  function renderGames(){
    if (!els.games) return;
    els.games.innerHTML = '';
    const ids = ['luckycube'].filter(id => APP_REGISTRY[id]);
    if (!ids.length){ if (els.gamesEmpty) els.gamesEmpty.style.display='block'; return; }
    if (els.gamesEmpty) els.gamesEmpty.style.display='none';
    for (const id of ids){
      const el = appRow(id);
      if (el) els.games.appendChild(el);
    }
  }

  function renderApps(){
    els.apps.innerHTML = '';
    const ids = DEFAULT_UNASSIGNED.filter(id => APP_REGISTRY[id]);
    if (!ids.length){ els.appsEmpty.style.display='block'; return; }
    els.appsEmpty.style.display='none';
    for (const id of ids){
      const el = appRow(id);
      if (el) els.apps.appendChild(el);
    }
  }

  function renderFolders(layout, locks){
    const folders = (layout?.folders || []).slice();
    els.folders.innerHTML = '';
    if (!folders.length){ els.foldersEmpty.style.display='block'; return; }
    els.foldersEmpty.style.display='none';
    for (const f of folders){
      const locked = !!(locks && locks[f.id]);
      els.folders.appendChild(folderRow(f, locked));
    }
  }

  async function init(){
    setStatus('loading');
    renderApps();
    renderGames();

    // Wenn wir aus einer Ordner-App auf Home kamen: einmal zurueck in den Ordner,
    // aber ohne neuen PIN (Token liegt in sessionStorage).
    const backFolder = sessionStorage.getItem(returnKey());
    if (backFolder){
      sessionStorage.removeItem(returnKey());
      const tok = sessionStorage.getItem(tokenKey(backFolder));
      if (tok){
        location.replace(`/folder?folderId=${encodeURIComponent(backFolder)}`);
        return;
      }
    }

    try{
      const data = await apiLayout();
      renderFolders(data.layout, data.locks);
      setStatus('loaded');
    }catch{
      renderFolders({folders:[]}, {});
      setStatus('error');
    }
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
