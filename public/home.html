<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Home</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#070c16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />

  <style>
    :root {
      --bg0: #05080f;
      --bg1: #070c16;
      --panel: rgba(17, 24, 39, 0.72);
      --panel2: rgba(20, 28, 46, 0.78);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --accent: #3ee38c;
      --accent2: #2fce7a;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);
      --radius: 18px;
      --danger: #ff4d6d;
    }

    html, body{
      height: auto;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      color-scheme: dark;
    }
    body{
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,0.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,0.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 28px);
      box-sizing: border-box;
    }
    body::before{
      content:"";
      position: fixed;
      top: 0; left: 0; right: 0;
      height: env(safe-area-inset-top);
      background: #070c16;
      z-index: 999999;
      pointer-events:none;
    }

    .container{
      background: var(--panel);
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 26px 26px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 1100px;
      width: 100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    h1{ margin:0; font-size: 2rem; letter-spacing: .2px; }
    h2{ margin: 18px 0 10px; font-size: 1.45rem; letter-spacing: .2px; }

    .btn{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color: #03130a;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 0.92rem;
      font-weight: 800;
      cursor: pointer;
      margin: 4px;
      transition: transform 0.15s ease, filter 0.2s ease;
      box-shadow: 0 10px 24px rgba(62,227,140,0.14);
      user-select: none;
      white-space: nowrap;
    }
    .btn:hover{ filter: brightness(1.03); }
    .btn:active{ transform: translateY(1px); }
    .btn-small{ padding: 6px 12px; font-size: .85rem; margin:0; }
    .btn-secondary{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    .btn-secondary:hover{ filter: brightness(1.06); }
    .btn-danger{
      background: rgba(255,77,109,0.10);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,77,109,0.28);
      box-shadow: none;
    }

    .sync-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      user-select:none;
      white-space: nowrap;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .toolbar .left, .toolbar .right{ display:flex; align-items:center; gap:8px; flex-wrap: wrap; }

    .hint{
      color: var(--muted);
      font-weight: 800;
      margin: 8px 0 0;
    }

    ul{ list-style:none; padding:0; margin:0; }
    .row{
      display:flex;
      align-items:center;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 10px;
      gap:12px;
      -webkit-user-select:none;
      user-select:none;
      flex-wrap: wrap;
      cursor: pointer;
      transition: transform 0.12s ease, filter 0.2s ease;
    }
    .row:hover{ filter: brightness(1.03); }
    .row:active{ transform: translateY(1px); }

    .icon{
      width:44px;
      height:44px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      font-size: 20px;
      flex: 0 0 auto;
    }

    .main{
      flex: 1 1 320px;
      min-width: 220px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .title{
      font-weight: 900;
      font-size: 1.05rem;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .meta{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      color: rgba(255,255,255,0.82);
      font-weight: 800;
      font-size: 0.86rem;
    }
    .tag{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      padding: 6px 10px;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    .actions{
      display:flex;
      gap:6px;
      flex-wrap: wrap;
      margin-left: auto;
      align-items: center;
    }

    .popup-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      overscroll-behavior: contain;
      padding: 12px;
    }
    .popup-overlay.active{ display:flex; }

    body.modal-open{ overflow:hidden; }
    html.modal-open{ overflow:hidden; }

    .popup{
      position: relative;
      background: rgba(15, 20, 34, 0.92);
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 20px 22px;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      min-width: 300px;
      max-width: min(720px, 92vw);
      max-height: 86vh;
      overflow: hidden;
      box-sizing: border-box;
    }
    .popup-close{
      position:absolute;
      top:10px;
      right:12px;
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      user-select:none;
    }

    .popup h3{ margin:0 0 12px; font-weight: 900; }
    .popup p{ margin:0 0 10px; color: var(--text); font-weight: 900; }

    input[type="text"]{
      width: 100%;
      margin-bottom: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,0.25);
      color: var(--text);
      box-sizing: border-box;
      font-size: 16px;
      min-width: 0;
      outline: none;
    }
    input::placeholder{ color: rgba(235,244,255,0.55); }

    .popup-buttons{
      text-align:right;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    @media (max-width: 640px){
      .container{ padding: 20px 16px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <h1>Home</h1>
        <div class="sync-pill" id="sync-pill" title="Cloud Sync">
          <span id="sync-dot" style="width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.35);box-shadow:0 0 12px rgba(255,255,255,0.12);"></span>
          <span id="sync-text" style="color:rgba(255,255,255,0.80);font-weight:900;font-size:12px;">Lade‚Ä¶</span>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="add-folder" class="btn btn-small btn-secondary" type="button">+ Ordner</button>
        <button id="add-app" class="btn btn-small" type="button">+ App</button>
        <button id="open-settings" class="btn btn-small btn-secondary" type="button">‚öôÔ∏è</button>
      </div>
    </div>

    <h2 style="margin-top:0;">Ordner</h2>
    <ul id="folders-list"></ul>
    <div class="hint" id="folders-hint"></div>

    <h2>Apps</h2>
    <ul id="apps-list"></ul>
    <div class="hint" id="apps-hint"></div>
  </div>

  <!-- Popup -->
  <div id="popup-overlay" class="popup-overlay">
    <div class="popup">
      <button class="popup-close" type="button" id="popup-x" aria-label="Schlie√üen">‚úï</button>
      <h3 id="popup-title">Popup</h3>
      <p id="popup-message"></p>

      <div id="popup-form"></div>

      <div class="popup-buttons">
        <button id="popup-cancel" class="btn btn-small btn-secondary" type="button">Abbrechen</button>
        <button id="popup-ok" class="btn btn-small" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Folder modal -->
  <div id="folder-overlay" class="popup-overlay">
    <div class="popup">
      <button class="popup-close" type="button" id="folder-x" aria-label="Schlie√üen">‚úï</button>
      <h3 id="folder-title">Ordner</h3>
      <p style="margin-bottom:12px;">Tippe auf eine App zum √ñffnen. Rechts: Entfernen.</p>
      <ul id="folder-apps-list"></ul>
      <div class="hint" id="folder-hint"></div>
      <div class="popup-buttons">
        <button id="folder-close" class="btn btn-small btn-secondary" type="button">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ===== Cloud Storage =====
      // Erwartet im Worker:
      //   GET  /api/home/data  -> { ok:true, data:{...} }
      //   PUT  /api/home/data  -> { ok:true }
      // F√§llt automatisch auf localStorage zur√ºck, damit IMMER was angezeigt wird.

      const LS_KEY = "homeData_v1";
      const API_URL = "/api/home/data";

      const DEFAULT_DATA = {
        folders: [
          { id: "f_start", name: "Start", icon: "üìÅ", items: [] }
        ],
        apps: [
          { id: "a_todo",  name: "To-Do",  icon: "‚úÖ", href: "/todo" }
        ],
        settings: { useCloud: true }
      };

      let data = null;

      // Sync UI
      const syncDot = document.getElementById("sync-dot");
      const syncText = document.getElementById("sync-text");
      function setSync(state, text){
        syncDot.style.background = state === "ok" ? "rgba(62,227,140,0.9)"
                           : state === "bad" ? "rgba(255,77,109,0.9)"
                           : "rgba(255,255,255,0.75)";
        syncDot.style.boxShadow = state === "ok" ? "0 0 14px rgba(62,227,140,0.55)"
                           : state === "bad" ? "0 0 14px rgba(255,77,109,0.55)"
                           : "0 0 14px rgba(255,255,255,0.35)";
        syncText.textContent = text;
      }

      function clone(x){ return JSON.parse(JSON.stringify(x)); }
      function safeParse(json, fallback){ try{ return JSON.parse(json); }catch(e){ return fallback; } }

      function makeId(prefix){
        return (prefix||"id") + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
      }

      function ensureShape(){
        if (!data || typeof data !== "object") data = clone(DEFAULT_DATA);
        if (!Array.isArray(data.folders)) data.folders = [];
        if (!Array.isArray(data.apps)) data.apps = [];
        if (!data.settings || typeof data.settings !== "object") data.settings = { useCloud: true };
        if (typeof data.settings.useCloud !== "boolean") data.settings.useCloud = true;

        data.folders = data.folders.map(f=>({
          id: String(f.id || makeId("f")),
          name: String(f.name || "Ordner"),
          icon: String(f.icon || "üìÅ"),
          items: Array.isArray(f.items) ? f.items.map(String) : []
        }));

        data.apps = data.apps.map(a=>({
          id: String(a.id || makeId("a")),
          name: String(a.name || "App"),
          icon: String(a.icon || "üß©"),
          href: String(a.href || "/")
        }));
      }

      function saveLocal(){
        try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch(e){}
      }
      async function loadLocal(){
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return clone(DEFAULT_DATA);
        const obj = safeParse(raw, null);
        return obj || clone(DEFAULT_DATA);
      }

      async function apiGet(){
        const r = await fetch(API_URL, { credentials: "include" });
        if (r.status === 401) throw new Error("unauthorized");
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j || j.ok !== true) throw new Error(j?.error || "load_failed");
        return j.data;
      }
      async function apiPut(){
        const r = await fetch(API_URL, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(data)
        });
        if (r.status === 401) throw new Error("unauthorized");
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j || j.ok !== true) throw new Error(j?.error || "save_failed");
      }

      let saveTimer = null;
      let saving = false;
      let queued = false;

      function scheduleSave(){
        saveLocal();
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> saveNow().catch(()=>{}), 250);
        setSync("work", "Speichere‚Ä¶");
      }
      async function saveNow(){
        if (saving){ queued = true; return; }
        saving = true;
        try{
          if (data.settings.useCloud){
            await apiPut();
            setSync("ok","Cloud");
          } else {
            setSync("ok","Lokal");
          }
        }catch(e){
          data.settings.useCloud = false;
          saveLocal();
          setSync("bad","Lokal (Cloud Fehler)");
        }finally{
          saving = false;
          if (queued){ queued = false; scheduleSave(); }
        }
      }

      // ===== Popup helper =====
      const popOverlay = document.getElementById("popup-overlay");
      const popTitle = document.getElementById("popup-title");
      const popMsg = document.getElementById("popup-message");
      const popForm = document.getElementById("popup-form");
      const popOk = document.getElementById("popup-ok");
      const popCancel = document.getElementById("popup-cancel");
      const popX = document.getElementById("popup-x");

      function openModal(el){
        el.classList.add("active");
        document.body.classList.add("modal-open");
        document.documentElement.classList.add("modal-open");
      }
      function closeModal(el){
        el.classList.remove("active");
        document.body.classList.remove("modal-open");
        document.documentElement.classList.remove("modal-open");
      }

      function promptForm(title, message, fields){
        popTitle.textContent = title || "Eingabe";
        popMsg.textContent = message || "";
        popForm.innerHTML = "";

        fields.forEach(f=>{
          const inp = document.createElement("input");
          inp.type = "text";
          inp.placeholder = f.placeholder || "";
          inp.value = f.value || "";
          inp.setAttribute("data-key", f.key);
          inp.autocomplete = "off";
          popForm.appendChild(inp);
        });

        openModal(popOverlay);

        return new Promise((resolve)=>{
          const onOk = ()=>{
            const inputs = Array.from(popForm.querySelectorAll("input"));
            const out = {};
            inputs.forEach(i=> out[i.getAttribute("data-key")] = i.value);
            cleanup();
            resolve({ ok:true, values: out });
          };
          const onCancel = ()=>{ cleanup(); resolve({ ok:false, values:{} }); };

          function cleanup(){
            popOk.removeEventListener("click", onOk);
            popCancel.removeEventListener("click", onCancel);
            popX.removeEventListener("click", onCancel);
            popOverlay.removeEventListener("click", onOverlay);
            closeModal(popOverlay);
          }
          function onOverlay(e){ if (e.target === popOverlay) onCancel(); }

          popOk.addEventListener("click", onOk);
          popCancel.addEventListener("click", onCancel);
          popX.addEventListener("click", onCancel);
          popOverlay.addEventListener("click", onOverlay);

          const first = popForm.querySelector("input");
          if (first) setTimeout(()=> first.focus(), 20);
        });
      }

      function confirmPopup(title, message){
        popTitle.textContent = title || "Sicher?";
        popMsg.textContent = message || "";
        popForm.innerHTML = "";
        openModal(popOverlay);

        return new Promise((resolve)=>{
          const onOk = ()=> cleanup(true);
          const onCancel = ()=> cleanup(false);
          function cleanup(val){
            popOk.removeEventListener("click", onOk);
            popCancel.removeEventListener("click", onCancel);
            popX.removeEventListener("click", onCancel);
            popOverlay.removeEventListener("click", onOverlay);
            closeModal(popOverlay);
            resolve(val);
          }
          function onOverlay(e){ if (e.target === popOverlay) onCancel(); }

          popOk.addEventListener("click", onOk);
          popCancel.addEventListener("click", onCancel);
          popX.addEventListener("click", onCancel);
          popOverlay.addEventListener("click", onOverlay);
        });
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // Folder modal
      const folderOverlay = document.getElementById("folder-overlay");
      const folderTitle = document.getElementById("folder-title");
      const folderAppsList = document.getElementById("folder-apps-list");
      const folderHint = document.getElementById("folder-hint");
      const folderClose = document.getElementById("folder-close");
      const folderX = document.getElementById("folder-x");

      function openFolder(folderId){
        const folder = data.folders.find(f=>f.id === folderId);
        if (!folder) return;

        folderTitle.textContent = (folder.icon || "üìÅ") + " " + folder.name;
        folderAppsList.innerHTML = "";

        const ids = folder.items || [];
        const apps = ids.map(id=> data.apps.find(a=>a.id===id)).filter(Boolean);

        folderHint.textContent = apps.length ? "" : "Keine Apps drin. (Bei einer App: ‚ãØ ‚Üí In Ordner)";

        apps.forEach(app=>{
          const li = document.createElement("li");
          li.className = "row";
          li.style.cursor = "default";

          const ic = document.createElement("div");
          ic.className = "icon";
          ic.textContent = app.icon || "üß©";

          const main = document.createElement("div");
          main.className = "main";
          main.innerHTML = '<div class="title"></div><div class="meta"></div>';
          main.querySelector(".title").textContent = app.name;
          main.querySelector(".meta").innerHTML = '<span class="tag">' + escapeHtml(app.href) + '</span>';

          const actions = document.createElement("div");
          actions.className = "actions";

          const openBtn = document.createElement("button");
          openBtn.className = "btn btn-small btn-secondary";
          openBtn.textContent = "√ñffnen";
          openBtn.addEventListener("click", ()=> location.href = app.href);

          const remBtn = document.createElement("button");
          remBtn.className = "btn btn-small btn-danger";
          remBtn.textContent = "Entfernen";
          remBtn.addEventListener("click", ()=>{
            folder.items = (folder.items||[]).filter(x=>x!==app.id);
            scheduleSave();
            openFolder(folderId);
            render();
          });

          actions.appendChild(openBtn);
          actions.appendChild(remBtn);

          li.appendChild(ic);
          li.appendChild(main);
          li.appendChild(actions);
          folderAppsList.appendChild(li);
        });

        openModal(folderOverlay);
      }
      function closeFolder(){ closeModal(folderOverlay); }
      folderClose.addEventListener("click", closeFolder);
      folderX.addEventListener("click", closeFolder);
      folderOverlay.addEventListener("click", (e)=>{ if (e.target===folderOverlay) closeFolder(); });

      // Render
      const foldersList = document.getElementById("folders-list");
      const appsList = document.getElementById("apps-list");
      const foldersHint = document.getElementById("folders-hint");
      const appsHint = document.getElementById("apps-hint");

      function render(){
        ensureShape();

        foldersList.innerHTML = "";
        foldersHint.textContent = data.folders.length ? "" : "Noch keine Ordner. (+ Ordner)";

        data.folders.forEach(folder=>{
          const li = document.createElement("li");
          li.className = "row";
          li.addEventListener("click", ()=> openFolder(folder.id));

          const ic = document.createElement("div");
          ic.className = "icon";
          ic.textContent = folder.icon || "üìÅ";

          const main = document.createElement("div");
          main.className = "main";
          main.innerHTML = '<div class="title"></div><div class="meta"></div>';
          main.querySelector(".title").textContent = folder.name;
          const count = (folder.items||[]).length;
          main.querySelector(".meta").innerHTML = '<span class="tag">' + count + ' App' + (count===1?'':'s') + '</span>';

          const actions = document.createElement("div");
          actions.className = "actions";

          const more = document.createElement("button");
          more.className = "btn btn-small btn-secondary";
          more.type = "button";
          more.textContent = "‚ãØ";
          more.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const res = await promptForm("Ordner", "√Ñndern:", [
              { key:"name", placeholder:"Name", value: folder.name },
              { key:"icon", placeholder:"Icon (z.B. üìÅ)", value: folder.icon }
            ]);
            if (!res.ok) return;
            const name = (res.values.name||"").trim();
            const icon = (res.values.icon||"").trim();
            if (name) folder.name = name;
            if (icon) folder.icon = icon;
            scheduleSave();
            render();
          });

          const del = document.createElement("button");
          del.className = "btn btn-small btn-danger";
          del.type = "button";
          del.textContent = "L√∂schen";
          del.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const ok = await confirmPopup("Ordner l√∂schen", "Wirklich l√∂schen?");
            if (!ok) return;
            data.folders = data.folders.filter(f=>f.id!==folder.id);
            scheduleSave();
            render();
          });

          actions.appendChild(more);
          actions.appendChild(del);

          li.appendChild(ic);
          li.appendChild(main);
          li.appendChild(actions);
          foldersList.appendChild(li);
        });

        appsList.innerHTML = "";
        appsHint.textContent = data.apps.length ? "" : "Noch keine Apps. (+ App)";

        data.apps.forEach(app=>{
          const li = document.createElement("li");
          li.className = "row";
          li.addEventListener("click", ()=> location.href = app.href);

          const ic = document.createElement("div");
          ic.className = "icon";
          ic.textContent = app.icon || "üß©";

          const main = document.createElement("div");
          main.className = "main";
          main.innerHTML = '<div class="title"></div><div class="meta"></div>';
          main.querySelector(".title").textContent = app.name;
          main.querySelector(".meta").innerHTML = '<span class="tag">' + escapeHtml(app.href) + '</span>';

          const actions = document.createElement("div");
          actions.className = "actions";

          const more = document.createElement("button");
          more.className = "btn btn-small btn-secondary";
          more.type = "button";
          more.textContent = "‚ãØ";
          more.addEventListener("click", async (e)=>{
            e.stopPropagation();

            const res = await promptForm("App", "√Ñndern / in Ordner:", [
              { key:"name", placeholder:"Name", value: app.name },
              { key:"icon", placeholder:"Icon (z.B. ‚úÖ)", value: app.icon },
              { key:"href", placeholder:"Link (z.B. /todo)", value: app.href },
              { key:"folder", placeholder:"In Ordner (Name exakt, optional)", value: "" }
            ]);
            if (!res.ok) return;

            const name = (res.values.name||"").trim();
            const icon = (res.values.icon||"").trim();
            const href = (res.values.href||"").trim();
            const folderName = (res.values.folder||"").trim();

            if (name) app.name = name;
            if (icon) app.icon = icon;
            if (href) app.href = href;

            if (folderName){
              const folder = data.folders.find(f=> (f.name||"").toLowerCase() === folderName.toLowerCase());
              if (folder){
                folder.items = Array.from(new Set([...(folder.items||[]), app.id]));
              }
            }

            scheduleSave();
            render();
          });

          const del = document.createElement("button");
          del.className = "btn btn-small btn-danger";
          del.type = "button";
          del.textContent = "L√∂schen";
          del.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const ok = await confirmPopup("App l√∂schen", "Wirklich l√∂schen?");
            if (!ok) return;
            data.folders.forEach(f=> f.items = (f.items||[]).filter(x=>x!==app.id));
            data.apps = data.apps.filter(a=>a.id!==app.id);
            scheduleSave();
            render();
          });

          actions.appendChild(more);
          actions.appendChild(del);

          li.appendChild(ic);
          li.appendChild(main);
          li.appendChild(actions);
          appsList.appendChild(li);
        });
      }

      // Buttons
      document.getElementById("add-folder").addEventListener("click", async ()=>{
        const res = await promptForm("Neuer Ordner", "Ordner erstellen:", [
          { key:"name", placeholder:"Name (z.B. Schule)", value:"" },
          { key:"icon", placeholder:"Icon (z.B. üìö)", value:"üìÅ" }
        ]);
        if (!res.ok) return;
        const name = (res.values.name||"").trim();
        const icon = (res.values.icon||"").trim() || "üìÅ";
        if (!name) return;
        data.folders.unshift({ id: makeId("f"), name, icon, items: [] });
        scheduleSave();
        render();
      });

      document.getElementById("add-app").addEventListener("click", async ()=>{
        const res = await promptForm("Neue App", "App hinzuf√ºgen:", [
          { key:"name", placeholder:"Name (z.B. Vokabeln)", value:"" },
          { key:"icon", placeholder:"Icon (z.B. üß†)", value:"üß©" },
          { key:"href", placeholder:"Link (z.B. /vokabeln)", value:"/" }
        ]);
        if (!res.ok) return;
        const name = (res.values.name||"").trim();
        const icon = (res.values.icon||"").trim() || "üß©";
        const href = (res.values.href||"").trim() || "/";
        if (!name) return;
        data.apps.unshift({ id: makeId("a"), name, icon, href });
        scheduleSave();
        render();
      });

      document.getElementById("open-settings").addEventListener("click", async ()=>{
        const res = await promptForm("Einstellungen", "Cloud Sync an/aus:", [
          { key:"useCloud", placeholder:"Cloud? (ja/nein)", value: (data?.settings?.useCloud ? "ja" : "nein") }
        ]);
        if (!res.ok) return;
        const v = (res.values.useCloud||"").trim().toLowerCase();
        data.settings.useCloud = (v === "ja" || v === "j" || v === "true" || v === "1");
        scheduleSave();
        render();
      });

      async function init(){
        // Lokal zuerst -> damit du IMMER was siehst
        setSync("work","Lade‚Ä¶");
        data = await loadLocal();
        ensureShape();
        render();
        setSync("ok","Lokal");

        // Dann Cloud versuchen
        try{
          if (data.settings.useCloud){
            const cloud = await apiGet();
            if (cloud){
              data = cloud;
              ensureShape();
              saveLocal();
              render();
              setSync("ok","Cloud");
            }
          }
        }catch(e){
          setSync("bad","Lokal (Cloud Fehler)");
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
