<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Home</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#070c16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />

  <style>
    :root{
      --bg0:#05080f; --bg1:#070c16;
      --panel:rgba(17,24,39,.72);
      --panel2:rgba(20,28,46,.78);
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }

    html,body{min-height:100vh; overflow-x:hidden; overflow-y:auto; color-scheme:dark;}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,0.10), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,0.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 28px);
      box-sizing:border-box;
    }
    body::before{
      content:"";
      position:fixed;
      top:0;left:0;right:0;
      height:env(safe-area-inset-top);
      background:#070c16;
      z-index:999999;
      pointer-events:none;
    }

    .container{
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      padding:26px 26px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-width:1100px;
      width:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:2rem; letter-spacing:.2px;}
    h2{margin:18px 0 10px; font-size:1.45rem; letter-spacing:.2px;}

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06);
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background:rgba(255,255,255,0.35);
      box-shadow:0 0 12px rgba(255,255,255,0.12);
      flex:0 0 auto;
    }
    .status-text{
      color:rgba(255,255,255,0.80);
      font-weight:900;
      font-size:12px;
    }

    ul{list-style:none; padding:0; margin:0;}
    .row{
      display:flex;
      align-items:center;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      margin-bottom:10px;
      gap:12px;
      user-select:none;
      cursor:pointer;
      transition:transform .12s ease, filter .2s ease;
    }
    .row:hover{filter:brightness(1.03);}
    .row:active{transform:translateY(1px);}

    .icon{
      width:44px; height:44px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.22);
      font-size:20px;
      flex:0 0 auto;
    }

    .main{
      flex:1 1 auto;
      min-width:220px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title{
      font-weight:900;
      font-size:1.05rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color:rgba(255,255,255,0.82);
      font-weight:800;
      font-size:0.86rem;
    }
    .tag{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.06);
      border-radius:999px;
      padding:6px 10px;
      white-space:nowrap;
      font-variant-numeric:tabular-nums;
    }

    .empty{
      margin-top:10px;
      color:var(--muted);
      font-weight:900;
    }

    @media (max-width:640px){
      .container{padding:20px 16px;}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Home</h1>
      <div class="status-pill" title="Status">
        <span id="dot" class="dot"></span>
        <span id="statusText" class="status-text">Laden</span>
      </div>
    </div>

    <h2 style="margin-top:0;">Apps</h2>
    <ul id="apps"></ul>
    <div id="empty" class="empty" style="display:none;">Keine Apps.</div>
  </div>

  <script>
    (function(){
      // Anzeige-only: keine Buttons, kein Bearbeiten, kein LÃ¶schen.
      // Status:
      //  - Laden (grauer Punkt)
      //  - Geladen (gruener Punkt)
      //  - Fehler beim Laden (roter Punkt)

      const LS_KEY = "homeApps_v1";
      const API_URL = "/api/home/data";

      const DEFAULT = {
        apps: [
          { id:"a_todo", name:"To-Do", icon:"âœ…", href:"/todo" }
        ]
      };

      let data = null;

      const dot = document.getElementById("dot");
      const statusText = document.getElementById("statusText");
      const appsUl = document.getElementById("apps");
      const empty = document.getElementById("empty");

      function setStatus(mode){
        if (mode === "loading"){
          dot.style.background = "rgba(255,255,255,0.45)";
          dot.style.boxShadow = "0 0 12px rgba(255,255,255,0.20)";
          statusText.textContent = "Laden";
        } else if (mode === "loaded"){
          dot.style.background = "rgba(62,227,140,0.95)";
          dot.style.boxShadow = "0 0 14px rgba(62,227,140,0.55)";
          statusText.textContent = "Geladen";
        } else {
          dot.style.background = "rgba(255,77,109,0.95)";
          dot.style.boxShadow = "0 0 14px rgba(255,77,109,0.55)";
          statusText.textContent = "Fehler beim Laden";
        }
      }

      function clone(x){ return JSON.parse(JSON.stringify(x)); }
      function safeParse(j, fallback){ try{ return JSON.parse(j); }catch(e){ return fallback; } }

      function normalizeApps(apps){
        if (!Array.isArray(apps)) return [];
        return apps.map(a=>({
          id: String(a?.id || ""),
          name: String(a?.name || "App"),
          icon: String(a?.icon || "ðŸ§©"),
          href: String(a?.href || "/")
        }));
      }

      function loadLocal(){
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return clone(DEFAULT);
        const obj = safeParse(raw, null);
        if (!obj || typeof obj !== "object") return clone(DEFAULT);
        return { apps: normalizeApps(obj.apps) };
      }

      function saveLocal(){
        try{ localStorage.setItem(LS_KEY, JSON.stringify({ apps: data.apps })); }catch(e){}
      }

      function render(){
        appsUl.innerHTML = "";
        const apps = normalizeApps(data?.apps);
        data.apps = apps;

        if (!apps.length){
          empty.style.display = "block";
          return;
        }
        empty.style.display = "none";

        apps.forEach(app=>{
          const li = document.createElement("li");
          li.className = "row";
          li.addEventListener("click", ()=> location.href = app.href);

          const ic = document.createElement("div");
          ic.className = "icon";
          ic.textContent = app.icon;

          const main = document.createElement("div");
          main.className = "main";

          const title = document.createElement("div");
          title.className = "title";
          title.textContent = app.name;

          const meta = document.createElement("div");
          meta.className = "meta";
          const tag = document.createElement("span");
          tag.className = "tag";
          tag.textContent = app.href;
          meta.appendChild(tag);

          main.appendChild(title);
          main.appendChild(meta);

          li.appendChild(ic);
          li.appendChild(main);
          appsUl.appendChild(li);
        });
      }

      async function cloudGet(){
        const r = await fetch(API_URL, { credentials: "include" });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j || j.ok !== true) throw new Error(j?.error || "load_failed");
        const payload = j.data || {};
        return { apps: normalizeApps(payload.apps) };
      }

      async function init(){
        setStatus("loading");

        // Local sofort -> damit du IMMER was siehst
        data = loadLocal();
        render();

        // Cloud versuchen
        try{
          const cloud = await cloudGet();
          if (cloud && Array.isArray(cloud.apps)){
            data = cloud;
            saveLocal();
            render();
          }
          setStatus("loaded");
        }catch(e){
          setStatus("error");
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
