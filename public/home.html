<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Home</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#070c16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />

  <style>
    :root{
      --bg0:#05080f; --bg1:#070c16;
      --panel:rgba(17,24,39,.72);
      --panel2:rgba(20,28,46,.78);
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }

    html,body{min-height:100vh; overflow-x:hidden; overflow-y:auto; color-scheme:dark;}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,0.10), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,0.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 28px);
      box-sizing:border-box;
    }
    body::before{
      content:"";
      position:fixed;
      top:0;left:0;right:0;
      height:env(safe-area-inset-top);
      background:#070c16;
      z-index:999999;
      pointer-events:none;
    }

    .container{
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      padding:26px 26px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-width:1100px;
      width:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:2rem; letter-spacing:.2px;}
    h2{margin:18px 0 10px; font-size:1.45rem; letter-spacing:.2px;}

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06);
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background:rgba(255,255,255,0.35);
      box-shadow:0 0 12px rgba(255,255,255,0.12);
      flex:0 0 auto;
    }
    .status-text{
      color:rgba(255,255,255,0.80);
      font-weight:900;
      font-size:12px;
    }

    ul{list-style:none; padding:0; margin:0;}
    .row{
      display:flex;
      align-items:center;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px 14px;
      margin-bottom:10px;
      gap:12px;
      user-select:none;
      cursor:default;
      transition:transform .12s ease, filter .2s ease;
    }
    .row.click{ cursor:pointer; }
    .row:hover{filter:brightness(1.03);}
    .row:active{transform:translateY(1px);}

    .icon{
      width:44px; height:44px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.22);
      font-size:20px;
      flex:0 0 auto;
    }

    .title{
      font-weight:900;
      font-size:1.10rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .empty{
      margin-top:10px;
      color:var(--muted);
      font-weight:900;
    }

    @media (max-width:640px){
      .container{padding:20px 16px;}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Home</h1>
      <div class="status-pill" title="Status">
        <span id="dot" class="dot"></span>
        <span id="statusText" class="status-text">Laden</span>
      </div>
    </div>

    <!-- Ordner-Sektion wird ausgeblendet, wenn keine Ordner existieren -->
    <div id="foldersSection" style="display:none;">
      <h2 style="margin-top:0;">Ordner</h2>
      <ul id="folders"></ul>
    </div>

    <h2 id="appsHeading" style="margin-top:0;">Apps</h2>
    <ul id="apps"></ul>
    <div id="appsEmpty" class="empty" style="display:none;">Keine Apps.</div>
  </div>

<script>
(() => {
  const APP_REGISTRY = {
    settings:  { id:"settings",  name:"Einstellungen",  icon:"‚öôÔ∏è", href:"/settings.html" },
    vokabeln:  { id:"vokabeln",  name:"Vokabeln",       icon:"üóÇÔ∏è", href:"/vokabeln.html" },
    lernen:    { id:"lernen",    name:"Lernen",         icon:"üß†", href:"/lernen" },
    packliste: { id:"packliste", name:"Packliste",      icon:"üß≥", href:"/packliste.html" },
    einkauf:   { id:"einkauf",   name:"Einkaufsliste",  icon:"üõí", href:"/einkaufsliste" },
    todo:      { id:"todo",      name:"ToDo",           icon:"‚úÖ", href:"/todo.html" },
    misterx:   { id:"misterx",   name:"MisterX",        icon:"‚ùå", href:"/MisterX.html" },
    webcam:    { id:"webcam",    name:"Webcam",         icon:"üì∑", href:"/webcam-live" }
  };
  const DEFAULT_UNASSIGNED = ["settings","vokabeln","lernen","packliste","einkauf","todo","misterx","webcam"];

  const FOLDER = { id:"f_5e9d0745127ad6dd", name:"Ordner", icon:"üìÅ" };

  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  function setStatus(mode){
    if (mode === "loading"){
      dot.style.background = "rgba(255,255,255,0.45)";
      dot.style.boxShadow = "0 0 12px rgba(255,255,255,0.20)";
      statusText.textContent = "Laden";
    } else if (mode === "loaded"){
      dot.style.background = "rgba(62,227,140,0.95)";
      dot.style.boxShadow = "0 0 14px rgba(62,227,140,0.55)";
      statusText.textContent = "Geladen";
    } else {
      dot.style.background = "rgba(255,77,109,0.95)";
      dot.style.boxShadow = "0 0 14px rgba(255,77,109,0.55)";
      statusText.textContent = "Fehler beim Laden";
    }
  }

  const foldersSection = document.getElementById("foldersSection");
  const foldersUl = document.getElementById("folders");
  const appsUl = document.getElementById("apps");
  const appsEmpty = document.getElementById("appsEmpty");

  function normHref(href){
    href = String(href || "/");
    if (href.startsWith("http://") || href.startsWith("https://")) return href;
    if (href.startsWith("/")) return href;
    return "/" + href.replace(/^\.\//, "").replace(/^\/+/, "");
  }

  function appCard(appId){
    const app = APP_REGISTRY[appId];
    if (!app) return null;
    const li = document.createElement("li");
    li.className = "row click";
    li.addEventListener("click", ()=> location.href = normHref(app.href));
    const ic = document.createElement("div");
    ic.className = "icon";
    ic.textContent = app.icon || "üß©";
    const title = document.createElement("div");
    title.className = "title";
    title.textContent = app.name || appId;
    li.appendChild(ic);
    li.appendChild(title);
    return li;
  }

  // ===== Folder Overlay (leer) =====
  const style = document.createElement("style");
  style.textContent = `
    .overlayWrap{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.55);
      backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:9999; padding:18px; }
    .overlayCard{ max-width:720px; margin:0 auto; background:rgba(22,24,30,.92);
      border:1px solid rgba(255,255,255,.10); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.55); overflow:hidden; }
    .overlayTop{ display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid rgba(255,255,255,.10); }
    .overlayTitle{ display:flex; align-items:center; gap:10px; font-weight:800; }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92); padding:8px 10px; border-radius:12px; cursor:pointer; font-weight:700; }
    .muted{ color:rgba(255,255,255,.65); font-size:13px; }
    .modalWrap{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.60);
      backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:10000; padding:18px; }
    .modalCard{ max-width:520px; margin:12vh auto 0; background:rgba(22,24,30,.94);
      border:1px solid rgba(255,255,255,.10); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.55); overflow:hidden; }
    .modalHead{ padding:14px; border-bottom:1px solid rgba(255,255,255,.10); font-weight:900; }
    .modalBody{ padding:14px; }
    .field{ width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06); color:rgba(255,255,255,.92); padding:10px 12px; outline:none; font-size:15px; }
    .modalFoot{ padding:14px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; justify-content:flex-end; }
    .errText{ color:rgba(255,77,109,.95); font-size:13px; min-height:18px; margin-top:8px; }
  `;
  document.head.appendChild(style);

  const overlay = document.createElement("div");
  overlay.className = "overlayWrap";
  overlay.innerHTML = `
    <div class="overlayCard">
      <div class="overlayTop">
        <div class="overlayTitle">
          <span id="ovIcon">üìÅ</span>
          <span id="ovName">Ordner</span>
        </div>
        <button class="btn" id="ovBack">Zur√ºck</button>
      </div>
      <div style="padding:14px;">
        <div class="muted" id="ovHint">Ordner ist leer.</div>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  overlay.querySelector("#ovBack").addEventListener("click", ()=> overlay.style.display="none");
  const ovIcon = overlay.querySelector("#ovIcon");
  const ovName = overlay.querySelector("#ovName");

  // ===== PIN Modal =====
  const modal = document.createElement("div");
  modal.className = "modalWrap";
  modal.innerHTML = `
    <div class="modalCard">
      <div class="modalHead">Ordner entsperren</div>
      <div class="modalBody">
        <div class="muted">Bitte PIN eingeben.</div>
        <div style="height:10px"></div>
        <input id="mPin" class="field" type="password" placeholder="PIN" autocomplete="current-password" />
        <div class="errText" id="mErr"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="mCancel">Abbrechen</button>
        <button class="btn" id="mOk">Entsperren</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const mPin = modal.querySelector("#mPin");
  const mErr = modal.querySelector("#mErr");
  const mCancel = modal.querySelector("#mCancel");
  const mOk = modal.querySelector("#mOk");

  function showModal(){ modal.style.display="block"; mErr.textContent=""; mPin.value=""; setTimeout(()=>mPin.focus(),30); }
  function hideModal(){ modal.style.display="none"; mPin.value=""; mErr.textContent=""; }

  async function apiUnlockFolder(folderId, pin){
    const r = await fetch("/api/home/folder/unlock", {
      method:"POST",
      credentials:"include",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ folderId, pin })
    });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j?.ok) throw new Error(j?.error || ("unlock_http_" + r.status));
    return true; // token ignorieren (du willst ja jedes Mal PIN)
  }

  function askPinEveryTime(folder){
    return new Promise((resolve)=>{
      showModal();

      async function onOk(){
        const pin = String(mPin.value||"").trim();
        if (!pin){ mErr.textContent="PIN fehlt."; return; }
        try{
          await apiUnlockFolder(folder.id, pin);
          hideModal();
          cleanup();
          resolve(true);
        }catch(e){
          const msg = String(e?.message || e || "");
          if (msg.includes("too_many_attempts")) mErr.textContent = "Zu viele Versuche. Warte kurz.";
          else mErr.textContent = "Falsche PIN.";
        }
      }

      function onKey(e){
        if (e.key==="Enter") onOk();
        if (e.key==="Escape"){ hideModal(); cleanup(); resolve(false); }
      }
      function cleanup(){
        mOk.removeEventListener("click", onOk);
        mPin.removeEventListener("keydown", onKey);
        mCancel.removeEventListener("click", onCancel);
        modal.removeEventListener("click", onBg);
      }
      function onCancel(){ hideModal(); cleanup(); resolve(false); }
      function onBg(e){ if (e.target===modal){ hideModal(); cleanup(); resolve(false); } }

      mOk.addEventListener("click", onOk);
      mPin.addEventListener("keydown", onKey);
      mCancel.addEventListener("click", onCancel);
      modal.addEventListener("click", onBg);
    });
  }

  function renderApps(){
    appsUl.innerHTML = "";
    const visible = DEFAULT_UNASSIGNED.filter(id => APP_REGISTRY[id]);
    if (!visible.length){
      appsEmpty.style.display = "block";
      return;
    }
    appsEmpty.style.display = "none";
    for (const id of visible){
      const el = appCard(id);
      if (el) appsUl.appendChild(el);
    }
  }

  function renderFolder(){
    foldersSection.style.display = "block";
    foldersUl.innerHTML = "";

    const li = document.createElement("li");
    li.className = "row click";

    const ic = document.createElement("div");
    ic.className = "icon";
    ic.textContent = FOLDER.icon;

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = FOLDER.name + " üîí";

    li.appendChild(ic);
    li.appendChild(title);

    li.addEventListener("click", async ()=>{
      const ok = await askPinEveryTime(FOLDER);
      if (!ok) return;
      ovIcon.textContent = FOLDER.icon;
      ovName.textContent = FOLDER.name;
      overlay.style.display = "block"; // leer
    });

    foldersUl.appendChild(li);
  }

  async function pingBackendWithTimeout(){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 6000);
    try{
      const r = await fetch("/api/home/layout", { credentials:"include", signal: ctrl.signal });
      clearTimeout(t);
      setStatus(r.ok ? "loaded" : "error");
    }catch{
      clearTimeout(t);
      setStatus("error");
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    setStatus("loading");
    renderApps();
    renderFolder();
    pingBackendWithTimeout(); // Status h√§ngt nie fest
  });
})();
</script>
</body>
</html>
