<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Home</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="/app.css">

  <style>
    :root{
      --bg0:#05080f; --bg1:#070c16;
      --panel:rgba(17,24,39,.72);
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#3ee38c; --accent2:#2fce7a;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Segoe UI', Tahoma, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,0.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,0.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:22px 14px 38px;
    }
    .wrap{width:min(980px, 100%);}
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:8px 0 14px;
    }
    h1{margin:0; font-size:2rem; letter-spacing:.2px;}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition:transform .12s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:#03130a;
      box-shadow:0 10px 24px rgba(62,227,140,0.14);
      border:1px solid rgba(255,255,255,.10);
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:12px;
    }

    /* All tiles identical (no green) */
    .tile{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,0.06);
      padding:14px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      min-height:62px;
      cursor:pointer;
      user-select:none;
      transition:transform .12s ease, filter .2s ease, border-color .2s ease;
    }
    .tile:hover{border-color:rgba(255,255,255,.16); filter:brightness(1.02)}
    .tile:active{transform:translateY(1px)}
    .icon{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      font-size:18px;
    }
    .label{
      font-weight:900;
      font-size:1.05rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Edit drag handle + settings */
    .handle, .gear{
      margin-left:auto;
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      display:none;
      place-items:center;
      flex:0 0 auto;
    }
    .handle{cursor:grab}
    .handle:active{cursor:grabbing}
    .gear{cursor:pointer; margin-left:10px}
    .editing .handle, .editing .gear{display:grid;}
    .editing .tile{cursor:default;}
    .editing .tile:active{transform:none;}
    .dropHover{
      outline:2px dashed rgba(62,227,140,.6);
      outline-offset:2px;
      background:rgba(62,227,140,.08);
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalBack.show{display:flex;}
    .modal{
      width:min(640px, 100%);
      background:rgba(10,14,22,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:0 22px 70px rgba(0,0,0,.65);
      padding:16px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      max-height:85vh;
      overflow:auto;
    }
    .modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .modalTop h3{margin:0; font-size:1.1rem}
    .xbtn{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .inp{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      font-weight:700;
      outline:none;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px;}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .danger{
      background:rgba(255,77,109,.10);
      border-color:rgba(255,77,109,.30);
      color:#ffd6de;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>Home</h1>
      <div class="actions">
        <button class="btn" id="editBtn">‚úèÔ∏è Bearbeiten: AUS</button>
        <button class="btn primary" id="addFolderBtn">‚ûï Ordner</button>
      </div>
    </div>

    <div class="panel">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Create folder modal -->
  <div class="modalBack" id="createBack" aria-hidden="true">
    <div class="modal">
      <div class="modalTop">
        <h3>Ordner erstellen</h3>
        <button class="xbtn" id="createClose">‚úï</button>
      </div>
      <div class="muted" style="margin-bottom:8px;">Name</div>
      <input class="inp" id="folderNameInput" placeholder="Ordnername" maxlength="40" />
      <div class="muted" style="margin:12px 0 8px;">Icon</div>
      <div class="row" style="justify-content:flex-start;">
        <span class="pill" data-icon="üìÅ">üìÅ</span>
        <span class="pill" data-icon="üéì">üéì</span>
        <span class="pill" data-icon="üìö">üìö</span>
        <span class="pill" data-icon="üß†">üß†</span>
        <span class="pill" data-icon="üóÇÔ∏è">üóÇÔ∏è</span>
        <span class="pill" data-icon="‚úèÔ∏è">‚úèÔ∏è</span>
      </div>
      <div class="muted" style="margin:12px 0 8px;">oder eigenes Emoji</div>
      <input class="inp" id="folderIconInput" placeholder="z.B. üè´" maxlength="8" />
      <div class="row">
        <button class="btn" id="createCancel">Abbrechen</button>
        <button class="btn primary" id="createOk">Erstellen</button>
      </div>
    </div>
  </div>

  <!-- Folder settings modal -->
  <div class="modalBack" id="settingsBack" aria-hidden="true">
    <div class="modal">
      <div class="modalTop">
        <h3>Ordner bearbeiten</h3>
        <button class="xbtn" id="settingsClose">‚úï</button>
      </div>

      <div class="muted" style="margin-bottom:8px;">Name</div>
      <input class="inp" id="renameInput" maxlength="40" />

      <div class="muted" style="margin:12px 0 8px;">Icon</div>
      <div class="row" style="justify-content:flex-start;">
        <span class="pill" data-icon="üìÅ">üìÅ</span>
        <span class="pill" data-icon="üè´">üè´</span>
        <span class="pill" data-icon="üéì">üéì</span>
        <span class="pill" data-icon="üìö">üìö</span>
        <span class="pill" data-icon="üß†">üß†</span>
        <span class="pill" data-icon="üóÇÔ∏è">üóÇÔ∏è</span>
        <span class="pill" data-icon="‚úèÔ∏è">‚úèÔ∏è</span>
      </div>
      <div class="muted" style="margin:12px 0 8px;">oder eigenes Emoji</div>
      <input class="inp" id="iconInput" maxlength="8" placeholder="z.B. üè´" />

      <div class="row" style="justify-content:space-between; margin-top:14px;">
        <div class="muted" id="pinState">PIN: ‚Ä¶</div>
        <button class="btn" id="gotoPinBtn">üîí PIN verwalten</button>
      </div>

      <div class="row">
        <button class="btn danger" id="deleteFolderBtn">üóëÔ∏è Ordner l√∂schen</button>
        <button class="btn primary" id="saveFolderBtn">Speichern</button>
      </div>

      <div id="pinBox" style="display:none; margin-top:14px;">
        <div style="height:1px; background:rgba(255,255,255,.10); margin:12px 0;"></div>
        <div style="font-weight:900;">PIN</div>
        <div class="muted">Zum √Ñndern/Entfernen musst du den Ordner vorher entsperren (in der Ordner-Seite).</div>
        <div class="muted" style="margin-top:10px;">Neue PIN setzen</div>
        <input class="inp" id="newPinInput" inputmode="numeric" pattern="[0-9]*" placeholder="z.B. 1234" />
        <div class="row">
          <button class="btn primary" id="setPinBtn">PIN setzen</button>
          <button class="btn danger" id="removePinBtn">PIN entfernen</button>
        </div>
        <div class="muted" id="pinMsg" style="margin-top:8px;"></div>
      </div>

    </div>
  </div>

<script>
const APP_REGISTRY = {
  settings:   { id:"settings",   name:"Einstellungen", icon:"‚öôÔ∏è", href:"settings.html"  },
  vokabeln:   { id:"vokabeln",   name:"Vokabeln",      icon:"üóÇÔ∏è", href:"vokabeln.html"  },
  lernen:     { id:"lernen",     name:"Lernen",        icon:"üìö", href:"/lernen"        },
  packliste:  { id:"packliste",  name:"Packliste",     icon:"üéí", href:"packliste.html" },
  einkauf:    { id:"einkauf",    name:"Einkaufsliste", icon:"üõí", href:"/einkaufsliste" },
  todo:       { id:"todo",       name:"ToDo",          icon:"üßæ", href:"todo.html"      },
  misterx:    { id:"misterx",    name:"MisterX",       icon:"‚ùå", href:"MisterX.html"  },
  webcam:     { id:"webcam",     name:"Webcam",        icon:"üì∑", href:"/webcam-live"  }
};
const DEFAULT_UNASSIGNED = ["settings","vokabeln","lernen","packliste","einkauf","todo","misterx","webcam"];

let editMode = false;
let layout = { folders: [], unassigned: [...DEFAULT_UNASSIGNED] };
let folderLockMap = {}; // folderId -> true/false

const grid = document.getElementById("grid");
const editBtn = document.getElementById("editBtn");
const addFolderBtn = document.getElementById("addFolderBtn");

/* ===== Edit mode ===== */
function setEditMode(on){
  editMode = !!on;
  editBtn.textContent = editMode ? "‚úèÔ∏è Bearbeiten: AN" : "‚úèÔ∏è Bearbeiten: AUS";
  document.body.classList.toggle("editing", editMode);
  render();
}
editBtn.addEventListener("click", () => setEditMode(!editMode));

/* ===== Modals ===== */
const createBack = document.getElementById("createBack");
const createClose = document.getElementById("createClose");
const createCancel = document.getElementById("createCancel");
const createOk = document.getElementById("createOk");
const folderNameInput = document.getElementById("folderNameInput");
const folderIconInput = document.getElementById("folderIconInput");

let createPickedIcon = "üìÅ";
createBack.querySelectorAll("[data-icon]").forEach(p=>{
  p.addEventListener("click", ()=>{ createPickedIcon = p.getAttribute("data-icon") || "üìÅ"; });
});

function openCreate(){
  folderNameInput.value = "";
  folderIconInput.value = "";
  createPickedIcon = "üìÅ";
  createBack.classList.add("show");
  createBack.setAttribute("aria-hidden", "false");
  setTimeout(()=>folderNameInput.focus(), 0);
}
function closeCreate(){
  createBack.classList.remove("show");
  createBack.setAttribute("aria-hidden", "true");
}
createClose.addEventListener("click", closeCreate);
createCancel.addEventListener("click", closeCreate);
createBack.addEventListener("click", (e)=>{ if(e.target===createBack) closeCreate(); });

addFolderBtn.addEventListener("click", openCreate);

/* Settings modal */
const settingsBack = document.getElementById("settingsBack");
const settingsClose = document.getElementById("settingsClose");
const renameInput = document.getElementById("renameInput");
const iconInput = document.getElementById("iconInput");
const saveFolderBtn = document.getElementById("saveFolderBtn");
const deleteFolderBtn = document.getElementById("deleteFolderBtn");
const pinState = document.getElementById("pinState");
const gotoPinBtn = document.getElementById("gotoPinBtn");

const pinBox = document.getElementById("pinBox");
const newPinInput = document.getElementById("newPinInput");
const setPinBtn = document.getElementById("setPinBtn");
const removePinBtn = document.getElementById("removePinBtn");
const pinMsg = document.getElementById("pinMsg");

let settingsFolderId = null;
let settingsPickedIcon = "üìÅ";

settingsBack.querySelectorAll("[data-icon]").forEach(p=>{
  p.addEventListener("click", ()=>{ settingsPickedIcon = p.getAttribute("data-icon") || "üìÅ"; });
});

function openSettings(folderId){
  settingsFolderId = folderId;
  const f = layout.folders.find(x => x.id === folderId);
  renameInput.value = f?.name || "";
  settingsPickedIcon = f?.icon || "üìÅ";
  iconInput.value = f?.icon || "";
  pinState.textContent = "PIN: " + (folderLockMap[folderId] ? "aktiv" : "aus");
  pinBox.style.display = "none";
  pinMsg.textContent = "";
  newPinInput.value = "";
  settingsBack.classList.add("show");
  settingsBack.setAttribute("aria-hidden","false");
}
function closeSettings(){
  settingsBack.classList.remove("show");
  settingsBack.setAttribute("aria-hidden","true");
  settingsFolderId = null;
}
settingsClose.addEventListener("click", closeSettings);
settingsBack.addEventListener("click", (e)=>{ if(e.target===settingsBack) closeSettings(); });

gotoPinBtn.addEventListener("click", ()=>{
  pinBox.style.display = (pinBox.style.display === "none") ? "block" : "none";
});

/* ===== API ===== */
async function apiGetLayout(){
  const r = await fetch("/api/home/layout", { credentials:"include" });
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j?.ok) throw new Error(j?.error || "layout_load_failed");
  return j;
}
async function apiPutLayout(){
  const body = { folders: layout.folders, unassigned: layout.unassigned };
  const r = await fetch("/api/home/layout", {
    method:"PUT",
    credentials:"include",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j?.ok) throw new Error(j?.error || "layout_save_failed");
}
async function apiGetFolderItems(folderId){
  const u = new URL(location.origin + "/api/home/folder/items");
  u.searchParams.set("folderId", folderId);
  const r = await fetch(u.toString(), { credentials:"include" });
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j?.ok) throw new Error(j?.error || "folder_items_load_failed");
  return j.items || [];
}
async function apiPutFolderItems(folderId, items){
  const r = await fetch("/api/home/folder/items", {
    method:"PUT",
    credentials:"include",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ folderId, items })
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j?.ok) throw new Error(j?.error || "folder_items_save_failed");
}
async function apiSetFolderPin(folderId, pin){
  const r = await fetch("/api/home/folder/setPin", {
    method:"POST",
    credentials:"include",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ folderId, pin })
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j?.ok) throw new Error(j?.error || "set_pin_failed");
}
async function apiRemoveFolderPin(folderId){
  const r = await fetch("/api/home/folder/removePin", {
    method:"POST",
    credentials:"include",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify({ folderId })
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok || !j?.ok) throw new Error(j?.error || "remove_pin_failed");
}

/* ===== Create folder ===== */
function cryptoRandomId(){
  const bytes = new Uint8Array(10);
  crypto.getRandomValues(bytes);
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,16);
}
createOk.addEventListener("click", async () => {
  const name = (folderNameInput.value || "").trim().slice(0,40);
  if (!name) return;
  const icon = (folderIconInput.value || "").trim().slice(0,8) || createPickedIcon || "üìÅ";
  const id = "f_" + cryptoRandomId();
  layout.folders.unshift({ id, name, icon });
  folderLockMap[id] = false;
  closeCreate();
  await apiPutLayout();
  render();
});

/* ===== Folder settings actions ===== */
saveFolderBtn.addEventListener("click", async ()=>{
  const f = layout.folders.find(x => x.id === settingsFolderId);
  if (!f) return;
  const name = (renameInput.value || "").trim().slice(0,40) || "Ordner";
  const icon = (iconInput.value || "").trim().slice(0,8) || settingsPickedIcon || "üìÅ";
  f.name = name;
  f.icon = icon;
  try{
    await apiPutLayout();
    render();
    closeSettings();
  }catch(e){ console.log(e); }
});

deleteFolderBtn.addEventListener("click", async ()=>{
  if (!settingsFolderId) return;
  if (!confirm("Ordner l√∂schen? (Inhalt kommt zur√ºck auf Home)")) return;

  const id = settingsFolderId;

  try{
    // 1) hole Inhalte aus dem Ordner
    const items = await apiGetFolderItems(id).catch(()=>[]);
    // 2) lege sie zur√ºck auf Home (unassigned)
    for (const appId of items){
      if (!layout.unassigned.includes(appId)) layout.unassigned.push(appId);
    }
    // 3) Ordner aus Layout entfernen
    layout.folders = layout.folders.filter(x => x.id !== id);

    // 4) Layout speichern
    await apiPutLayout();

    // 5) Ordner-Inhalte serverseitig leeren (optional cleanup)
    await apiPutFolderItems(id, []).catch(()=>{});

  }catch(e){
    console.log(e);
  }

  render();
  closeSettings();
});

setPinBtn.addEventListener("click", async ()=>{
  if (!settingsFolderId) return;
  const pin = String(newPinInput.value||"").trim();
  if (!pin || pin.length < 4) { pinMsg.textContent = "PIN min. 4 Ziffern."; return; }
  try{
    await apiSetFolderPin(settingsFolderId, pin);
    folderLockMap[settingsFolderId] = true;
    pinState.textContent = "PIN: aktiv";
    pinMsg.textContent = "PIN gesetzt. (√Ñndern/Entfernen sp√§ter im Ordner nach Entsperren)";
    newPinInput.value = "";
    render();
  }catch(e){
    console.log(e);
    pinMsg.textContent = "Fehler (bei aktivem PIN musst du im Ordner entsperren und dort √§ndern).";
  }
});

removePinBtn.addEventListener("click", async ()=>{
  if (!settingsFolderId) return;
  try{
    await apiRemoveFolderPin(settingsFolderId);
    folderLockMap[settingsFolderId] = false;
    pinState.textContent = "PIN: aus";
    pinMsg.textContent = "PIN entfernt.";
    render();
  }catch(e){
    console.log(e);
    pinMsg.textContent = "Nicht m√∂glich ohne Entsperren. Geh in den Ordner und entsperr ihn, dann PIN entfernen.";
  }
});

/* ===== UI ===== */
function tileEl({icon,label,onClick,draggable,data,showGear,gearClick}){
  const el = document.createElement("div");
  el.className = "tile";
  el.tabIndex = 0;

  const ic = document.createElement("div");
  ic.className = "icon";
  ic.textContent = icon;

  const lb = document.createElement("div");
  lb.className = "label";
  lb.textContent = label;

  const handle = document.createElement("div");
  handle.className = "handle";
  handle.textContent = "‚†ø";
  handle.title = "Ziehen";

  const gear = document.createElement("div");
  gear.className = "gear";
  gear.textContent = "‚öôÔ∏è";
  gear.title = "Ordner bearbeiten";

  el.appendChild(ic);
  el.appendChild(lb);

  if (showGear){
    el.appendChild(gear);
    gear.addEventListener("click", (e)=>{ e.stopPropagation(); gearClick(); });
  }

  el.appendChild(handle);

  if (!editMode){
    el.addEventListener("click", onClick);
    el.addEventListener("keydown", (e)=>{ if(e.key==="Enter") onClick(); });
  }

  if (draggable){
    el.draggable = true;
    el.addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", JSON.stringify(data));
      e.dataTransfer.effectAllowed = "move";
    });
  }

  return el;
}

async function moveAppToFolder(appId, folderId){
  if (folderLockMap[folderId]) return; // locked: must move inside folder after unlock
  layout.unassigned = layout.unassigned.filter(x => x !== appId);
  const items = await apiGetFolderItems(folderId);
  if (!items.includes(appId)) items.push(appId);
  await apiPutFolderItems(folderId, items);
  await apiPutLayout();
}

function render(){
  grid.innerHTML = "";

  const folderCount = layout.folders.length;

  function addDropReorder(el, target){
    // target: {kind:'folder', id} or {kind:'app', id}
    el.addEventListener("dragover", (e)=>{
      if (!editMode) return;
      e.preventDefault();
      el.classList.add("dropHover");
      e.dataTransfer.dropEffect = "move";
    });
    el.addEventListener("dragleave", ()=> el.classList.remove("dropHover"));
    el.addEventListener("drop", async (e)=>{
      if (!editMode) return;
      e.preventDefault();
      el.classList.remove("dropHover");

      let data=null;
      try{ data = JSON.parse(e.dataTransfer.getData("text/plain")); }catch{}
      if (!data?.type) return;

      // 1) app -> folder (move into folder)
      if (data.type === "app" && target.kind === "folder"){
        if (folderLockMap[target.id]) return;
        try{ await moveAppToFolder(data.appId, target.id); render(); }catch(err){ console.log(err); }
        return;
      }

      // 2) reorder folders
      if (data.type === "folder" && target.kind === "folder"){
        const fromIdx = layout.folders.findIndex(f => f.id === data.folderId);
        const toIdx   = layout.folders.findIndex(f => f.id === target.id);
        if (fromIdx < 0 || toIdx < 0 || fromIdx === toIdx) return;
        const [moved] = layout.folders.splice(fromIdx, 1);
        layout.folders.splice(toIdx, 0, moved);
        try{ await apiPutLayout(); }catch(err){ console.log(err); }
        render();
        return;
      }

      // 3) reorder apps (unassigned)
      if (data.type === "app" && target.kind === "app"){
        const fromIdx = layout.unassigned.indexOf(data.appId);
        const toIdx   = layout.unassigned.indexOf(target.id);
        if (fromIdx < 0 || toIdx < 0 || fromIdx === toIdx) return;
        const [moved] = layout.unassigned.splice(fromIdx, 1);
        layout.unassigned.splice(toIdx, 0, moved);
        try{ await apiPutLayout(); }catch(err){ console.log(err); }
        render();
        return;
      }
    });
  }

  // folders first
  for (const folder of layout.folders){
    const locked = !!folderLockMap[folder.id];
    const icon = folder.icon || "üìÅ";

    const el = tileEl({
      icon: locked ? "üîí" : icon,
      label: folder.name || "Ordner",
      onClick: ()=> location.href = "/home-folder.html?folderId=" + encodeURIComponent(folder.id),
      draggable: editMode,
      data: { type:"folder", folderId: folder.id },
      showGear: editMode,
      gearClick: ()=> openSettings(folder.id)
    });

    addDropReorder(el, { kind:"folder", id: folder.id });
    grid.appendChild(el);
  }

  // apps
  for (const appId of layout.unassigned){
    const app = APP_REGISTRY[appId];
    if (!app) continue;

    const el = tileEl({
      icon: app.icon || "‚¨õ",
      label: app.name,
      onClick: ()=> location.href = app.href,
      draggable: editMode,
      data: { type:"app", appId },
      showGear: false,
      gearClick: ()=>{}
    });

    addDropReorder(el, { kind:"app", id: appId });
    grid.appendChild(el);
  }
}

/* ===== Init ===== */
async function init(){
  try {
    const r = await fetch("/api/me", { credentials: "include" });
    if (r.status === 401) location.href = "/login?returnTo=" + encodeURIComponent(location.pathname + location.search);
  } catch (_) {
    location.href = "/login?returnTo=" + encodeURIComponent(location.pathname + location.search);
  }

  try{
    const data = await apiGetLayout();
    layout.folders = Array.isArray(data.layout?.folders) ? data.layout.folders : [];
    layout.unassigned = Array.isArray(data.layout?.unassigned) ? data.layout.unassigned : [...DEFAULT_UNASSIGNED];
    folderLockMap = data.locks || {};
  }catch(err){
    console.log(err);
  }
  render();
}
init();
</script>
</body>
</html>
