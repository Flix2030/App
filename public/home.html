<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Home</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="theme-color" content="#070c16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />

  <style>
    :root{
      --bg0:#05080f; --bg1:#070c16;
      --panel:rgba(17,24,39,.72);
      --panel2:rgba(20,28,46,.78);
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }

    html,body{min-height:100vh; overflow-x:hidden; overflow-y:auto; color-scheme:dark;}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,0.10), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,0.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 28px);
      box-sizing:border-box;
    }
    body::before{
      content:"";
      position:fixed;
      top:0;left:0;right:0;
      height:env(safe-area-inset-top);
      background:#070c16;
      z-index:999999;
      pointer-events:none;
    }

    .container{
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      padding:26px 26px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-width:1100px;
      width:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:2rem; letter-spacing:.2px;}
    h2{margin:18px 0 10px; font-size:1.45rem; letter-spacing:.2px;}

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06);
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background:rgba(255,255,255,0.35);
      box-shadow:0 0 12px rgba(255,255,255,0.12);
      flex:0 0 auto;
    }
    .status-text{
      color:rgba(255,255,255,0.80);
      font-weight:900;
      font-size:12px;
    }

    ul{list-style:none; padding:0; margin:0;}
    .row{
      display:flex;
      align-items:center;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      margin-bottom:10px;
      gap:12px;
      user-select:none;
      cursor:default;
      transition:transform .12s ease, filter .2s ease;
    }
    .row.click{ cursor:pointer; }
    .row:hover{filter:brightness(1.03);}
    .row:active{transform:translateY(1px);}

    .icon{
      width:44px; height:44px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.22);
      font-size:20px;
      flex:0 0 auto;
    }

    .main{
      flex:1 1 auto;
      min-width:220px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title{
      font-weight:900;
      font-size:1.05rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color:rgba(255,255,255,0.82);
      font-weight:800;
      font-size:0.86rem;
    }
    .tag{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.06);
      border-radius:999px;
      padding:6px 10px;
      white-space:nowrap;
      font-variant-numeric:tabular-nums;
    }

    .empty{
      margin-top:10px;
      color:var(--muted);
      font-weight:900;
    }

    @media (max-width:640px){
      .container{padding:20px 16px;}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Home</h1>
      <div class="status-pill" title="Status">
        <span id="dot" class="dot"></span>
        <span id="statusText" class="status-text">Laden</span>
      </div>
    </div>

    <h2 style="margin-top:0;">Ordner</h2>
    <ul id="folders"></ul>
    <div id="foldersEmpty" class="empty" style="display:none;">Keine Ordner.</div>

    <h2>Apps</h2>
    <ul id="apps"></ul>
    <div id="appsEmpty" class="empty" style="display:none;">Keine Apps.</div>
  </div>

  <script>
    (function(){
      // Anzeige-only: kein Bearbeiten, keine Buttons, kein LÃ¶schen.
      // Holt DEIN bestehendes Layout:
      //   GET /api/home/layout  -> { ok:true, layout:{ folders:[{id,name,icon}], unassigned:[appId...] }, locks:{} }
      // Folder-Inhalte:
      //   GET /api/home/folder/items?folderId=... -> { ok:true, items:[appId...] }

      /* ===== Registry (aus deinem Home) ===== */
      const APP_REGISTRY = {
        settings:  { id:"settings",  name:"Einstellungen",  icon:"âš™ï¸", href:"/settings.html" },
        vokabeln:  { id:"vokabeln",  name:"Vokabeln",       icon:"ðŸ—‚ï¸", href:"/vokabeln.html" },
        lernen:    { id:"lernen",    name:"Lernen",         icon:"ðŸ§ ", href:"/lernen" },
        packliste: { id:"packliste", name:"Packliste",      icon:"ðŸ§³", href:"/packliste.html" },
        einkauf:   { id:"einkauf",   name:"Einkaufsliste",  icon:"ðŸ›’", href:"/einkaufsliste" },
        todo:      { id:"todo",      name:"ToDo",           icon:"âœ…", href:"/todo.html" },
        misterx:   { id:"misterx",   name:"MisterX",        icon:"âŒ", href:"/MisterX.html" },
        webcam:    { id:"webcam",    name:"Webcam",         icon:"ðŸ“·", href:"/webcam-live" }
      };
      const DEFAULT_UNASSIGNED = ["settings","vokabeln","lernen","packliste","einkauf","todo","misterx","webcam"];

      /* ===== Status ===== */
      const dot = document.getElementById("dot");
      const statusText = document.getElementById("statusText");
      function setStatus(mode){
        if (mode === "loading"){
          dot.style.background = "rgba(255,255,255,0.45)";
          dot.style.boxShadow = "0 0 12px rgba(255,255,255,0.20)";
          statusText.textContent = "Laden";
        } else if (mode === "loaded"){
          dot.style.background = "rgba(62,227,140,0.95)";
          dot.style.boxShadow = "0 0 14px rgba(62,227,140,0.55)";
          statusText.textContent = "Geladen";
        } else {
          dot.style.background = "rgba(255,77,109,0.95)";
          dot.style.boxShadow = "0 0 14px rgba(255,77,109,0.55)";
          statusText.textContent = "Fehler beim Laden";
        }
      }

      /* ===== UI ===== */
      const foldersUl = document.getElementById("folders");
      const appsUl = document.getElementById("apps");
      const foldersEmpty = document.getElementById("foldersEmpty");
      const appsEmpty = document.getElementById("appsEmpty");

      function normHref(href){
        href = String(href || "/");
        if (href.startsWith("http://") || href.startsWith("https://")) return href;
        // absolute
        if (href.startsWith("/")) return href;
        // relative -> mache safe absolut
        return "/" + href.replace(/^\.\//, "").replace(/^\/+/, "");
      }

      function appCard(appId){
        const app = APP_REGISTRY[appId];
        if (!app) return null;

        const li = document.createElement("li");
        li.className = "row click";
        li.addEventListener("click", ()=> location.href = normHref(app.href));

        const ic = document.createElement("div");
        ic.className = "icon";
        ic.textContent = app.icon || "ðŸ§©";

        const main = document.createElement("div");
        main.className = "main";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = app.name || appId;

        const meta = document.createElement("div");
        meta.className = "meta";
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = normHref(app.href);
        meta.appendChild(tag);

        main.appendChild(title);
        main.appendChild(meta);

        li.appendChild(ic);
        li.appendChild(main);
        return li;
      }

      function folderCard(folder, count){
        const li = document.createElement("li");
        li.className = "row";

        const ic = document.createElement("div");
        ic.className = "icon";
        ic.textContent = folder.icon || "ðŸ“";

        const main = document.createElement("div");
        main.className = "main";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = folder.name || "Ordner";

        const meta = document.createElement("div");
        meta.className = "meta";
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = String(count || 0) + " Apps";
        meta.appendChild(tag);

        main.appendChild(title);
        main.appendChild(meta);

        li.appendChild(ic);
        li.appendChild(main);
        return li;
      }

      /* ===== API ===== */
      async function apiGetLayout(){
        const r = await fetch("/api/home/layout", { credentials:"include" });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j?.ok) throw new Error(j?.error || ("layout_http_" + r.status));
        return j; // { ok:true, layout:{folders,unassigned}, locks:{} }
      }

      async function apiGetFolderItems(folderId){
        const u = new URL(location.origin + "/api/home/folder/items");
        u.searchParams.set("folderId", folderId);
        const r = await fetch(u.toString(), { credentials:"include" });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j?.ok) throw new Error(j?.error || ("items_http_" + r.status));
        return Array.isArray(j.items) ? j.items : [];
      }

      function uniq(arr){
        const out = [];
        const seen = new Set();
        for (const x of arr){
          const k = String(x);
          if (seen.has(k)) continue;
          seen.add(k);
          out.push(k);
        }
        return out;
      }

      function allKnownAppIds(){
        // Reihenfolge: DEFAULT_UNASSIGNED dann Rest
        const ids = Object.keys(APP_REGISTRY);
        const rest = ids.filter(x=>!DEFAULT_UNASSIGNED.includes(x)).sort();
        return uniq([...DEFAULT_UNASSIGNED, ...rest]);
      }

      function renderFromLayout(layout, folderItemsMap){
        // Ordner
        foldersUl.innerHTML = "";
        const folders = Array.isArray(layout?.folders) ? layout.folders : [];
        if (!folders.length){
          foldersEmpty.style.display = "block";
        } else {
          foldersEmpty.style.display = "none";
          for (const f of folders){
            const count = (folderItemsMap?.[f.id]?.length || 0);
            foldersUl.appendChild(folderCard(f, count));
          }
        }

        // Apps (unassigned + alles was sonst nirgends ist)
        appsUl.innerHTML = "";
        const inFolders = new Set();
        for (const fid in (folderItemsMap||{})){
          for (const appId of (folderItemsMap[fid] || [])) inFolders.add(String(appId));
        }

        const unassigned = Array.isArray(layout?.unassigned) ? layout.unassigned.map(String) : [];
        const baseOrder = allKnownAppIds();

        // Alles was NICHT in folder ist:
        const visible = [];
        // zuerst layout.unassigned in layout-Reihenfolge
        for (const id of unassigned){
          if (!APP_REGISTRY[id]) continue;
          if (inFolders.has(id)) continue; // falls doppelt
          visible.push(id);
        }
        // dann rest in default order, was noch nicht gezeigt wurde und nicht im folder ist
        for (const id of baseOrder){
          if (!APP_REGISTRY[id]) continue;
          if (inFolders.has(id)) continue;
          if (visible.includes(id)) continue;
          visible.push(id);
        }

        if (!visible.length){
          appsEmpty.style.display = "block";
        } else {
          appsEmpty.style.display = "none";
          for (const id of visible){
            const el = appCard(id);
            if (el) appsUl.appendChild(el);
          }
        }
      }

      async function init(){
        setStatus("loading");

        try{
          const data = await apiGetLayout();
          const layout = data.layout || { folders:[], unassigned:[...DEFAULT_UNASSIGNED] };

          // hole Items pro Folder (damit Count stimmt)
          const folderItemsMap = {};
          const folders = Array.isArray(layout.folders) ? layout.folders : [];
          await Promise.all(folders.map(async (f)=>{
            try{
              const items = await apiGetFolderItems(f.id);
              folderItemsMap[f.id] = Array.isArray(items) ? items : [];
            }catch(_){
              folderItemsMap[f.id] = [];
            }
          }));

          renderFromLayout(layout, folderItemsMap);
          setStatus("loaded");
        }catch(err){
          // Fallback: zeige einfach alles aus Registry (ohne Ordner)
          renderFromLayout({ folders:[], unassigned: allKnownAppIds() }, {});
          setStatus("error");
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
