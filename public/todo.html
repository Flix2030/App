<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>To-Do</title>

  <!-- iPhone/PWA nicer -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#070c16" />
  <meta name="color-scheme" content="dark" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root {
      --bg0: #05080f;
      --bg1: #070c16;
      --panel: rgba(17, 24, 39, 0.72);
      --panel2: rgba(20, 28, 46, 0.78);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --accent: #3ee38c;
      --accent2: #2fce7a;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);
      --radius: 18px;
      --danger: #ff4d6d;
      --warn: #ffd369;
    }

    /* Base */
    html, body{
      height: auto;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      color-scheme: dark;
    }
    body{
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(62,227,140,0.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(79,140,255,0.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 28px);
      box-sizing: border-box;
    }

    /* safe-area dark bar */
    body::before{
      content:"";
      position: fixed;
      top: 0; left: 0; right: 0;
      height: env(safe-area-inset-top);
      background: #070c16;
      z-index: 999999;
      pointer-events:none;
    }

    .container{
      background: var(--panel);
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 26px 26px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 1100px;
      width: 100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    h1{ margin:0; font-size: 2rem; letter-spacing: .2px; }
    h2{ margin: 18px 0 10px; font-size: 1.45rem; letter-spacing: .2px; }

    /* Buttons / Links */
    .btn{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color: #03130a;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 0.92rem;
      font-weight: 700;
      cursor: pointer;
      margin: 4px;
      transition: transform 0.15s ease, filter 0.2s ease;
      box-shadow: 0 10px 24px rgba(62,227,140,0.14);
      user-select: none;
    }
    .btn:hover{ filter: brightness(1.03); }
    .btn:active{ transform: translateY(1px); }
    .btn-small{ padding: 6px 12px; font-size: .85rem; margin:0; }
    .btn-secondary{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    .btn-secondary:hover{ filter: brightness(1.06); }

    .back-link{
      display:inline-block;
      padding: 12px 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      text-decoration:none;
      user-select:none;
      white-space: nowrap;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .toolbar .left, .toolbar .right{ display:flex; align-items:center; gap:8px; flex-wrap: wrap; }

    /* Inputs */
    input[type="text"], input[type="time"]{
      padding: 12px 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      border-radius: 14px;
      font-size: 16px; /* no mobile zoom */
      outline: none;
      min-width: 220px;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder{ color: rgba(235,244,255,0.55); }

    ul{ list-style:none; padding:0; margin:0; }

    /* List items */
    .task-item{
      display:flex;
      align-items:center;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 10px;
      gap:12px;
      -webkit-user-select:none;
      user-select:none;
      flex-wrap: wrap;
    }
    .task-item.task-done{
      background: rgba(62,227,140,0.16) !important;
      border-color: rgba(62,227,140,0.65) !important;
      box-shadow: 0 0 0 3px rgba(62,227,140,0.10);
    }

    .task-check{
      width: 22px;
      height: 22px;
      accent-color: var(--accent);
      cursor:pointer;
      flex: 0 0 auto;
    }

    .task-main{
      flex: 1 1 320px;
      min-width: 220px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .task-title{
      font-weight: 900;
      font-size: 1.05rem;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .task-meta{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      color: rgba(255,255,255,0.82);
      font-weight: 800;
      font-size: 0.86rem;
    }
    .tag{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      padding: 6px 10px;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }
    .tag.warn{
      border-color: rgba(255,211,105,0.24);
      background: rgba(255,211,105,0.10);
      color: rgba(255,255,255,0.92);
    }

    .actions{
      display:flex;
      gap:6px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .hidden{ display:none; }

    .progress-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(62,227,140,0.25);
      background: rgba(62,227,140,0.10);
      color: var(--accent);
      font-weight: 800;
      font-size: 0.95rem;
      white-space: nowrap;
      box-shadow: 0 10px 30px rgba(62,227,140,0.08);
    }
    .progress-dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 16px rgba(62,227,140,0.65);
    }
    .progress-bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      overflow:hidden;
      margin: 12px 0 10px;
    }
    .progress-bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), rgba(62,227,140,0.35));
      border-radius: 999px;
      transition: width 220ms ease;
    }

    .add-row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
    }

    .days{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .day-chip{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.88);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: 0.9rem;
    }
    .day-chip.on{
      border-color: rgba(62,227,140,0.35);
      background: rgba(62,227,140,0.16);
    }
    .day-chip input{ display:none; }

    /* Modal / Popup overlay */
    .popup-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      overscroll-behavior: contain;
    }
    .popup-overlay.active{ display:flex; }

    /* Scroll lock when modal open (background must NOT scroll) */
    body.modal-open{ overflow:hidden; }
    html.modal-open{ overflow:hidden; }

    .popup{
      position: relative;
      background: rgba(15, 20, 34, 0.92);
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 20px 22px;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      min-width: 300px;
      max-width: min(720px, 92vw);
      max-height: 86vh;
      overflow: hidden;
      box-sizing: border-box;
    }

    .popup-close{
      position:absolute;
      top:10px;
      right:12px;
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      user-select:none;
    }
    .popup-close:hover{ filter: brightness(1.08); }

    .popup p{ margin:0 0 10px; color: var(--text); font-weight: 900; }
    .popup input[type="text"], .popup input[type="time"]{
      width: 100%;
      margin-bottom: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,0.25);
      color: var(--text);
      box-sizing: border-box;
      font-size: 16px;
      min-width: 0;
    }
    .popup-buttons{ text-align:right; display:flex; justify-content:flex-end; gap:8px; flex-wrap: wrap; }

    /* Switch */
    .switch{ position:relative; display:inline-block; width:52px; height:30px; flex:0 0 auto; }
    .switch input{ opacity:0; width:0; height:0; }
    .slider-round{
      position:absolute; cursor:pointer; inset:0;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      transition: .2s;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.18);
    }
    .slider-round:before{
      position:absolute; content:"";
      height:22px; width:22px;
      left:4px; top:50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.92);
      transition: .2s;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    .switch input:checked + .slider-round{
      background: rgba(62,227,140,0.22);
      border-color: rgba(62,227,140,0.55);
    }
    .switch input:checked + .slider-round:before{
      transform: translate(22px, -50%);
    }

    @media (max-width: 520px){
      input[type="text"], input[type="time"]{ min-width: 0; width: 100%; }
      .add-row{ gap:10px; }
      .actions{ margin-left: 0; }
      .task-title{ font-size: 1.15rem; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <h1>To-Do</h1>
        <div class="sync-pill" id="sync-pill" title="Cloud Sync">
          <span class="progress-dot" id="sync-dot" style="width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.35);box-shadow:0 0 12px rgba(255,255,255,0.12);"></span>
          <span id="sync-text" style="color:rgba(255,255,255,0.80);font-weight:900;font-size:12px;">Lade…</span>
        </div>
      </div>
      <a class="back-link" id="top-home-link" href="/home">&#x2B05; Home</a>
    </div>

    <div class="toolbar">
      <div class="left">
        <h2 style="margin:0;">Aufgaben</h2>
        <button id="edit-mode-toggle" class="btn btn-small btn-secondary">Bearbeiten</button>
      </div>
      <div class="right">
        <button id="open-settings-btn" class="btn btn-small btn-secondary">⚙️ Einstellungen</button>
      </div>
    </div>

    <div class="progress-bar"><div id="completion-bar"></div></div>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 10px;">
      <div class="progress-pill">
        <span class="progress-dot"></span>
        <span id="completion-percentage">0/0 erledigt</span>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="check-all-btn" class="btn btn-small btn-secondary">Alle abhaken</button>
        <button id="clear-all-btn" class="btn btn-small btn-secondary" style="border-color: rgba(255,77,109,0.25); background: rgba(255,77,109,0.10);">Alles löschen</button>
      </div>
    </div>

    <!-- Add / Quick add -->
    <div id="new-task-section" style="margin-top:10px;">
      <div class="add-row" style="margin-bottom: 10px;">
        <input type="text" id="quick-task-text" placeholder="wäsche aufhängen; mo, fr; 13:00 Uhr; Mama" style="flex: 1 1 420px;" />
        <button id="quick-add-btn" class="btn btn-small">Hinzufügen</button>
      </div>

      <div class="add-row">
        <input type="text" id="new-task-text" placeholder="Neue Aufgabe" style="flex: 2 1 320px;" />
        <div class="days" id="days-wrap" style="flex: 1 1 260px;"></div>
        <input type="time" id="new-task-time" value="13:00" style="min-width: 140px;" />
        <button id="no-time-btn" class="btn btn-small btn-secondary" type="button" title="Ohne Uhrzeit">Keine Uhrzeit</button>
        <input type="text" id="new-task-person" placeholder="Person (z.B. Mama)" style="flex: 1 1 180px; min-width: 160px;" />
        <button id="add-task-btn" class="btn btn-small">Erstellen</button>
      </div>
    </div>

    <ul id="tasks-list" style="margin-top: 14px;"></ul>
  </div>

  <!-- Einstellungen -->
  <div id="settings-modal" class="popup-overlay">
    <div class="popup">
      <button class="popup-close" type="button" id="settings-x" aria-label="Schließen">✕</button>

      <h3 style="margin:0 0 12px;">Einstellungen</h3>

      <div style="display:flex; flex-direction:column; gap:14px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div style="font-weight:900;">Fertige nach unten</div>
          <label class="switch" aria-label="Fertige nach unten">
            <input id="done-bottom-toggle" type="checkbox">
            <span class="slider-round"></span>
          </label>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div style="font-weight:900;">Abhaken mit Kästchen</div>
          <label class="switch" aria-label="Abhaken mit Kästchen">
            <input id="checkbox-toggle" type="checkbox">
            <span class="slider-round"></span>
          </label>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
        <button id="settings-close" class="btn btn-small btn-secondary" type="button">Schließen</button>
        <button id="settings-save" class="btn btn-small" type="button">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Popup (Prompt/Confirm/Edit) -->
  <div id="popup-overlay" class="popup-overlay">
    <div class="popup">
      <button class="popup-close" type="button" id="popup-x" aria-label="Schließen">✕</button>

      <p id="popup-message"></p>

      <input type="text" id="popup-input-title" class="hidden" placeholder="Aufgabe" />
      <div id="popup-days" class="days hidden" style="margin: 6px 0 10px;"></div>
      <input type="time" id="popup-input-time" class="hidden" />
      <button type="button" id="popup-no-time-btn" class="btn btn-small btn-secondary hidden" style="margin-bottom:10px;">Keine Uhrzeit</button>
      <input type="text" id="popup-input-person" class="hidden" placeholder="Person" />

      <div class="popup-buttons">
        <button id="popup-cancel" class="btn btn-small btn-secondary">Abbrechen</button>
        <button id="popup-confirm" class="btn btn-small">OK</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ===== Cloud Storage (0 localStorage for data) =====
      // HINWEIS: Frontend erwartet im Worker diese Endpoints:
      //   GET/PUT /api/todo/data  (auth via cookies wie bei deiner Einkaufsliste)
      // Wenn du (noch) keinen Endpoint hast, kannst du unten "USE_LOCAL_FALLBACK" aktivieren.

      const USE_LOCAL_FALLBACK = false; // <- auf true, wenn du erstmal ohne Backend testen willst

      const LS_FALLBACK_KEY = "todoData_fallback_v1";

      let data = { tasks: [], settings: { doneBottom:false, checkbox:false } };
      let editMode = false;

      // sync UI
      const syncDot = document.getElementById("sync-dot");
      const syncText = document.getElementById("sync-text");
      function setSync(state, text){
        // state: ok | bad | work
        if (!syncDot) return;
        syncDot.style.background = state === "ok" ? "rgba(62,227,140,0.9)"
                           : state === "bad" ? "rgba(255,77,109,0.9)"
                           : "rgba(255,255,255,0.75)";
        syncDot.style.boxShadow = state === "ok" ? "0 0 14px rgba(62,227,140,0.55)"
                           : state === "bad" ? "0 0 14px rgba(255,77,109,0.55)"
                           : "0 0 14px rgba(255,255,255,0.35)";
        if (syncText) syncText.textContent = text;
      }

      function redirectToLogin(){
        const rt = location.pathname + location.search + location.hash;
        location.href = "/login?returnTo=" + encodeURIComponent(rt);
      }

      async function apiGet(){
        if (USE_LOCAL_FALLBACK){
          try{
            const raw = localStorage.getItem(LS_FALLBACK_KEY);
            return raw ? JSON.parse(raw) : { tasks: [], settings: { doneBottom:false, checkbox:false } };
          }catch(e){
            return { tasks: [], settings: { doneBottom:false, checkbox:false } };
          }
        }

        const r = await fetch("/api/todo/data", { credentials: "include" });
        if (r.status === 401) redirectToLogin();
        const j = await r.json().catch(()=>null);
        if (!j || j.ok !== true) throw new Error(j?.error || "load_failed");
        return j.data || { tasks: [], settings: { doneBottom:false, checkbox:false } };
      }

      async function apiPut(obj){
        if (USE_LOCAL_FALLBACK){
          localStorage.setItem(LS_FALLBACK_KEY, JSON.stringify(obj));
          return;
        }

        const r = await fetch("/api/todo/data", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(obj)
        });
        if (r.status === 401) redirectToLogin();
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j || j.ok !== true) throw new Error(j?.error || "save_failed");
      }

      let saveTimer = null;
      let saving = false;
      let saveQueued = false;

      function scheduleSave(){
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> saveNow().catch(()=>{}), 250);
        setSync("work", "Speichere…");
      }

      async function saveNow(){
        if (saving){
          saveQueued = true;
          return;
        }
        saving = true;
        try{
          await apiPut(data);
          setSync("ok", "Gespeichert");
        }catch(e){
          setSync("bad", "Fehler");
          console.error(e);
        }finally{
          saving = false;
          if (saveQueued){
            saveQueued = false;
            scheduleSave();
          }
        }
      }

      function makeId(prefix){
        return (prefix||"id") + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
      }

      function ensureSettings(){
        if (!data.settings || typeof data.settings !== "object") data.settings = {};
        if (typeof data.settings.doneBottom !== "boolean") data.settings.doneBottom = false;
        if (typeof data.settings.checkbox !== "boolean") data.settings.checkbox = false;
      }

      // ===== Popup =====
      const overlay = document.getElementById("popup-overlay");
      const popupMessage = document.getElementById("popup-message");
      const popupTitle = document.getElementById("popup-input-title");
      const popupTime = document.getElementById("popup-input-time");
      const popupPerson = document.getElementById("popup-input-person");
      const popupDaysWrap = document.getElementById("popup-days");
      let popupCallback = null;

      document.getElementById("popup-confirm").addEventListener("click", ()=> popupCallback && popupCallback(true));
      document.getElementById("popup-cancel").addEventListener("click", ()=> popupCallback && popupCallback(false));
      document.getElementById("popup-x").addEventListener("click", ()=> popupCallback && popupCallback(false));

      function openOverlay(){
        overlay.classList.add("active");
        document.body.classList.add("modal-open");
        document.documentElement.classList.add("modal-open");
      }
      function closeOverlay(){
        overlay.classList.remove("active");
        document.body.classList.remove("modal-open");
        document.documentElement.classList.remove("modal-open");
      }

      function showConfirm(msg, onOk){
        popupMessage.textContent = msg;

        popupTitle.classList.add("hidden");
        popupTime.classList.add("hidden");
        popupPerson.classList.add("hidden");
        popupDaysWrap.classList.add("hidden");

        const popupNoTimeBtn = document.getElementById("popup-no-time-btn");
        popupNoTimeBtn.classList.add("hidden");

        openOverlay();
        popupCallback = (ok)=>{
          closeOverlay();
          if (ok) onOk();
          popupCallback = null;
        };
      }

      function buildDays(container, selected){
        const days = [
          { key:"mo", label:"Mo" },
          { key:"di", label:"Di" },
          { key:"mi", label:"Mi" },
          { key:"do", label:"Do" },
          { key:"fr", label:"Fr" },
          { key:"sa", label:"Sa" },
          { key:"so", label:"So" }
        ];

        container.innerHTML = "";
        days.forEach(d=>{
          const lab = document.createElement("label");
          lab.className = "day-chip" + (selected.includes(d.key) ? " on" : "");
          lab.innerHTML = `<input type="checkbox" data-day="${d.key}" ${selected.includes(d.key) ? "checked" : ""} /><span>${d.label}</span>`;
          lab.addEventListener("click", ()=>{
            const inp = lab.querySelector("input");
            setTimeout(()=> lab.classList.toggle("on", inp.checked), 0);
          });
          container.appendChild(lab);
        });
      }

      function readDays(container){
        return Array.from(container.querySelectorAll('input[type="checkbox"]'))
          .filter(x=>x.checked)
          .map(x=>x.dataset.day)
          .filter(Boolean);
      }

      function showTaskEditor(task, onOk){
        popupMessage.textContent = "Aufgabe bearbeiten:";

        popupTitle.classList.remove("hidden");
        popupTime.classList.remove("hidden");
        popupPerson.classList.remove("hidden");
        popupDaysWrap.classList.remove("hidden");

        popupTitle.value = task.title || "";
        popupTime.value = (task.time || "");

        const popupNoTimeBtn = document.getElementById("popup-no-time-btn");
        popupNoTimeBtn.classList.remove("hidden");
        popupNoTimeBtn.onclick = ()=>{ popupTime.value = ""; };
        popupPerson.value = task.person || "";

        buildDays(popupDaysWrap, (task.days || []));

        openOverlay();
        popupCallback = (ok)=>{
          if (!ok){
            closeOverlay();
            popupCallback = null;
            return;
          }
          const title = (popupTitle.value || "").trim();
          const time = normalizeTime(popupTime.value); // optional
          const person = (popupPerson.value || "").trim();
          const days = readDays(popupDaysWrap);

          if (!title) return; // stay open
          if (!days.length) return;

          closeOverlay();
          popupCallback = null;
          onOk({ title, time, person, days });
        };
      }

      // ===== Helpers =====
      const DAY_ORDER = ["mo","di","mi","do","fr","sa","so"];
      function fmtCreated(iso){
        try{
          const d = new Date(iso);
          if (isNaN(d)) return "";
          const dd = String(d.getDate()).padStart(2,"0");
          const mm = String(d.getMonth()+1).padStart(2,"0");
          const yyyy = d.getFullYear();
          const hh = String(d.getHours()).padStart(2,"0");
          const mi = String(d.getMinutes()).padStart(2,"0");
          return `${dd}.${mm}.${yyyy} ${hh}:${mi}`;
        }catch(e){ return ""; }
      }

      const DAY_LABEL = { mo:"Mo", di:"Di", mi:"Mi", do:"Do", fr:"Fr", sa:"Sa", so:"So" };

      function normalizeTime(s){
        if(!s) return "";
        s = String(s).toLowerCase().replace("uhr","").trim();
        s = s.replace(".", ":");
        if (/^\d{1,2}$/.test(s)) s = s.padStart(2,"0")+":00";
        if (!/^\d{1,2}:\d{2}$/.test(s)) return "";
        const [h,m] = s.split(":").map(x=>parseInt(x,10));
        if (!Number.isFinite(h) || !Number.isFinite(m) || h<0 || h>23 || m<0 || m>59) return "";
        return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
      }

      function parseDays(s){
        if(!s) return [];
        s = String(s).toLowerCase();
        const parts = s.split(/[,/ ]+/).map(x=>x.trim()).filter(Boolean);
        const out = [];
        for (const p of parts){
          const key = p.slice(0,2);
          if (DAY_LABEL[key] && !out.includes(key)) out.push(key);
        }
        out.sort((a,b)=> DAY_ORDER.indexOf(a) - DAY_ORDER.indexOf(b));
        return out;
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function fmtDays(days){
        const d = (days || []).slice().sort((a,b)=>DAY_ORDER.indexOf(a)-DAY_ORDER.indexOf(b));
        return d.map(x=>DAY_LABEL[x] || x).join(", ");
      }

      function isDone(t){ return !!t.done; }

      function updateCompletion(){
        const total = (data.tasks||[]).length;
        const done = (data.tasks||[]).filter(isDone).length;

        const label = document.getElementById("completion-percentage");
        const bar = document.getElementById("completion-bar");

        label.textContent = done + "/" + total + " erledigt";
        const pct = total ? (done/total)*100 : 0;
        bar.style.width = Math.max(0, Math.min(100, pct)).toFixed(2) + "%";
      }

      function ensureDataShape(){
        if (!data || typeof data !== "object") data = { tasks: [], settings: { doneBottom:false, checkbox:false } };
        if (!Array.isArray(data.tasks)) data.tasks = [];
        ensureSettings();

        // migrate minimal
        data.tasks = data.tasks.map(t=>{
          if (!t || typeof t !== "object") t = {};
          if (!t.id) t.id = makeId("task");
          if (typeof t.title !== "string") t.title = String(t.title ?? "");
          if (!Array.isArray(t.days)) t.days = [];
          t.days = t.days.map(x=>String(x).toLowerCase().slice(0,2)).filter(x=>DAY_LABEL[x]);
          t.days = Array.from(new Set(t.days)).sort((a,b)=>DAY_ORDER.indexOf(a)-DAY_ORDER.indexOf(b));
          t.time = normalizeTime(t.time) || "";
          if (typeof t.person !== "string") t.person = String(t.person ?? "");
          if (!t.createdAt) t.createdAt = new Date().toISOString();
          t.done = !!t.done;
          return t;
        });
      }

      // ===== Render =====
      function render(){
        ensureDataShape();

        const doneBottom = !!data.settings.doneBottom;
        const checkboxMode = !!data.settings.checkbox;

        const tasks = (data.tasks || []).slice();
        if (doneBottom){
          tasks.sort((a,b)=>(isDone(a)?1:0)-(isDone(b)?1:0));
        }

        updateCompletion();

        const ul = document.getElementById("tasks-list");
        ul.innerHTML = "";

        tasks.forEach(task=>{
          const li = document.createElement("li");
          li.className = "task-item" + (isDone(task) ? " task-done" : "");

          // checkbox or click anywhere
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "task-check";
          cb.checked = isDone(task);

          const main = document.createElement("div");
          main.className = "task-main";
          main.innerHTML = `
            <div class="task-title">${escapeHtml(task.title || "Aufgabe")}</div>
            <div class="task-meta">
              <span class="tag">${escapeHtml(fmtDays(task.days)) || "—"}</span>
              ${task.time ? `<span class="tag">${escapeHtml(task.time)} Uhr</span>` : `<span class="tag warn">ohne Uhrzeit</span>`}
              ${task.person ? `<span class="tag">${escapeHtml(task.person)}</span>` : ""}
              ${task.createdAt ? `<span class="tag">erstellt: ${escapeHtml(fmtCreated(task.createdAt))}</span>` : ""}
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "actions";

          if (editMode){
            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-small btn-secondary";
            editBtn.textContent = "Bearbeiten";
            editBtn.addEventListener("click",(e)=>{
              e.stopPropagation();
              showTaskEditor(task, (upd)=>{
                task.title = upd.title;
                task.time = upd.time;
                task.person = upd.person;
                task.days = upd.days;
                scheduleSave();
                render();
              });
            });
            actions.appendChild(editBtn);

            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-small btn-secondary";
            delBtn.textContent = "Entfernen";
            delBtn.addEventListener("click",(e)=>{
              e.stopPropagation();
              showConfirm(`Aufgabe "${task.title}" entfernen?`, ()=>{
                data.tasks = (data.tasks||[]).filter(t=>t.id!==task.id);
                scheduleSave();
                render();
              });
            });
            actions.appendChild(delBtn);
          }

          li.appendChild(cb);
          li.appendChild(main);
          if (editMode) li.appendChild(actions);

          const toggleDone = ()=>{
            task.done = !task.done;
            cb.checked = task.done;
            li.classList.toggle("task-done", task.done);
            scheduleSave();
            render();
          };

          if (checkboxMode){
            cb.addEventListener("click",(e)=> e.stopPropagation());
            cb.addEventListener("change", ()=>{
              task.done = cb.checked;
              scheduleSave();
              render();
            });
            // in checkboxMode: click on row toggles too (nice), but not required:
            li.addEventListener("click", ()=>{
              task.done = !task.done;
              scheduleSave();
              render();
            });
          } else {
            // no checkbox mode -> whole row toggles; checkbox is just a visual toggle
            cb.addEventListener("click",(e)=> e.stopPropagation());
            cb.addEventListener("change", toggleDone);
            li.addEventListener("click", toggleDone);
          }

          ul.appendChild(li);
        });
      }

      // ===== Create task =====
      function createTaskFromFields(){
        const title = (document.getElementById("new-task-text").value || "").trim();
        const time = normalizeTime(document.getElementById("new-task-time").value); // optional
        const person = (document.getElementById("new-task-person").value || "").trim();
        const days = readDays(document.getElementById("days-wrap"));

        if (!title || !days.length) return;

        data.tasks.unshift({
          id: makeId("task"),
          title, time, person, days,
          done: false,
          createdAt: new Date().toISOString()
        });

        document.getElementById("new-task-text").value = "";
        document.getElementById("new-task-person").value = "";
        scheduleSave();
        render();
      }

      function parseQuickLine(line){
        // Beispiele:
        //  "wäsche aufhängen; mo, fr; 13:00 Uhr; Mama"
        //  "wäsche aufhängen; mo, fr; Mama"   (ohne Uhrzeit)
        const parts = String(line).split(";").map(p=>p.trim());
        // keep empty fields (for ";;")
        while(parts.length && parts[parts.length-1] === "") parts.pop();
        if (parts.length < 2) return null;
        const title = (parts[0] || "").trim();
        const days = parseDays(parts[1] || "");
        let time = "";
        let person = "";
        if (parts.length >= 3){
          const maybeTime = normalizeTime(parts[2] || "");
          if (maybeTime){
            time = maybeTime;
            person = parts[3] ? String(parts[3]).trim() : "";
          } else {
            // no time -> treat as person
            time = "";
            person = parts[2] ? String(parts[2]).trim() : "";
          }
        }
        if (!title || !days.length) return null;
        return { title, days, time, person };
      }

      function createTaskFromQuick(){
        const inp = document.getElementById("quick-task-text");
        const parsed = parseQuickLine(inp.value || "");
        if (!parsed) return;
        data.tasks.unshift({ id: makeId("task"), done:false, createdAt: new Date().toISOString(), ...parsed });
        inp.value = "";
        scheduleSave();
        render();
      }

      // ===== Settings =====
      const settingsModal = document.getElementById("settings-modal");
      const doneBottomToggle = document.getElementById("done-bottom-toggle");
      const checkboxToggle = document.getElementById("checkbox-toggle");

      function openSettings(){
        ensureSettings();
        doneBottomToggle.checked = !!data.settings.doneBottom;
        checkboxToggle.checked = !!data.settings.checkbox;
        settingsModal.classList.add("active");
        document.body.classList.add("modal-open");
        document.documentElement.classList.add("modal-open");
      }
      function closeSettings(){
        settingsModal.classList.remove("active");
        document.body.classList.remove("modal-open");
        document.documentElement.classList.remove("modal-open");
      }

      // ===== Bind UI =====
      function bindUI(){
        // days chips in create row
        buildDays(document.getElementById("days-wrap"), ["mo","fr"]);

        document.getElementById("add-task-btn").addEventListener("click", createTaskFromFields);

        // Keine Uhrzeit (Create)
        document.getElementById("no-time-btn").addEventListener("click", ()=>{
          const t = document.getElementById("new-task-time");
          t.value = "";
        });
        document.getElementById("quick-add-btn").addEventListener("click", createTaskFromQuick);

        document.getElementById("quick-task-text").addEventListener("keydown", (e)=>{
          if (e.key === "Enter") createTaskFromQuick();
        });

        document.getElementById("new-task-person").addEventListener("keydown", (e)=>{
          if (e.key === "Enter") createTaskFromFields();
        });
        document.getElementById("new-task-text").addEventListener("keydown", (e)=>{
          if (e.key === "Enter") createTaskFromFields();
        });

        document.getElementById("edit-mode-toggle").addEventListener("click", function(){
          editMode = !editMode;
          this.textContent = editMode ? "Fertig" : "Bearbeiten";
          render();
        });

        document.getElementById("check-all-btn").addEventListener("click", ()=>{
          const total = (data.tasks||[]).length;
          if (!total) return;
          const allDone = data.tasks.every(t=>!!t.done);
          showConfirm(allDone ? "Alles wieder abwählen?" : "Alles abhaken?", ()=>{
            data.tasks.forEach(t=> t.done = !allDone);
            scheduleSave();
            render();
          });
        });

        document.getElementById("clear-all-btn").addEventListener("click", ()=>{
          showConfirm("Wirklich ALLES löschen?", ()=>{
            data.tasks = [];
            scheduleSave();
            render();
          });
        });

        // settings modal
        document.getElementById("open-settings-btn").addEventListener("click", openSettings);
        document.getElementById("settings-x").addEventListener("click", closeSettings);
        document.getElementById("settings-close").addEventListener("click", closeSettings);

        document.getElementById("settings-save").addEventListener("click", ()=>{
          ensureSettings();
          data.settings.doneBottom = !!doneBottomToggle.checked;
          data.settings.checkbox = !!checkboxToggle.checked;
          scheduleSave();
          render();
          closeSettings();
        });

        settingsModal.addEventListener("click", (e)=>{
          if (e.target === settingsModal) closeSettings();
        });

        overlay.addEventListener("click", (e)=>{
          if (e.target === overlay && popupCallback){
            popupCallback(false);
          }
        });
      }

      async function init(){
        try{
          setSync("work","Lade…");
          data = await apiGet();
          ensureDataShape();
          setSync("ok","Geladen");
        }catch(e){
          console.error(e);
          setSync("bad","Fehler");
          data = { tasks: [], settings: { doneBottom:false, checkbox:false } };
        }

        bindUI();
        render();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
